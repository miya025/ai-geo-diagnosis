---
import Layout from "../layouts/Layout.astro";

// Server-side language detection
const headers = Astro.request.headers;

// 1. Check Vercel IP country header (most reliable for deployed env)
const ipCountry = headers.get("x-vercel-ip-country");

// 2. Check Accept-Language header as fallback
const acceptLanguage = headers.get("accept-language") || "";
const prefersJapanese = acceptLanguage.toLowerCase().startsWith("ja");

// Determine initial language: Japanese only for Japan IP, otherwise English
let initialLang: "ja" | "en" = "en";
if (ipCountry === "JP") {
  initialLang = "ja";
} else if (!ipCountry && prefersJapanese) {
  // Local dev or no IP header: use browser preference
  initialLang = "ja";
}

// SEO content by language
const seoContent = {
  ja: {
    title: "AI GEOè¨ºæ–­ - AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³æœ€é©åŒ–ãƒã‚§ãƒƒã‚«ãƒ¼",
    description:
      "AIãŒã‚ãªãŸã®Webã‚µã‚¤ãƒˆã‚’AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆChatGPTã€Perplexityç­‰ï¼‰ã«å¼•ç”¨ã•ã‚Œã‚„ã™ã„ã‹ã©ã†ã‹è¨ºæ–­ã€‚GEOã‚¹ã‚³ã‚¢ã§å¯è¦–åŒ–ã—ã¾ã™ã€‚",
  },
  en: {
    title: "AI GEO Diagnosis - AI Search Engine Optimization Checker",
    description:
      "Check if your website is optimized for AI Search Engines like ChatGPT and Perplexity. Visualize your GEO score.",
  },
};

const { title, description } = seoContent[initialLang];
---

<Layout title={title} description={description} lang={initialLang}>
  <div
    class="min-h-screen bg-slate-50 font-sans selection:bg-indigo-100 selection:text-indigo-700 pb-20"
  >
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header
      class="sticky top-0 z-50 w-full bg-white/80 backdrop-blur-md border-b border-indigo-50 shadow-sm"
    >
      <div
        class="container mx-auto px-6 h-20 flex items-center justify-between"
      >
        <!-- Logo -->
        <a href="/" class="flex items-center gap-2 group">
          <div
            class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-indigo-200 group-hover:scale-110 transition-transform duration-300"
          >
            G
          </div>
          <span
            class="font-bold text-xl text-slate-800 tracking-tight group-hover:text-indigo-600 transition-colors whitespace-nowrap"
            data-i18n="title">AI GEOè¨ºæ–­</span
          >
        </a>

        <!-- Right Actions -->
        <div class="flex items-center gap-4">
          <!-- è¨€èªåˆ‡ã‚Šæ›¿ãˆ -->
          <div class="flex bg-slate-100 p-1 rounded-lg shadow-inner">
            <button
              id="lang-btn-ja"
              class="px-3 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all pointer-events-auto z-10"
              >JP</button
            >
            <button
              id="lang-btn-en"
              class="px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:text-indigo-600 transition-all pointer-events-auto z-10"
              >EN</button
            >
          </div>

          <!-- ãƒ­ã‚°ã‚¤ãƒ³ / ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
          <div class="flex items-center">
            <button
              id="header-login-btn"
              class="hidden text-sm font-bold text-indigo-600 bg-white px-3 md:px-5 py-2.5 rounded-full shadow-sm border border-indigo-100 hover:shadow-md hover:bg-indigo-50 transition-all whitespace-nowrap"
              data-i18n="login_suggest"
            >
              ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <div
              id="header-user-info"
              class="hidden items-center gap-3 pl-4 md:border-l md:border-slate-200"
            >
              <div class="text-right hidden md:block">
                <p id="user-email" class="text-xs text-slate-500 font-medium">
                </p>
                <div class="flex items-center justify-end gap-2">
                  <span
                    id="credit-badge"
                    class="inline-block text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full"
                    >æ®‹ã‚Š: -å›</span
                  >
                  <button
                    id="manage-subscription-btn"
                    class="hidden text-slate-400 hover:text-indigo-600 transition"
                    title="ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                      ></path>
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                  </button>
                </div>
              </div>
              <button
                id="header-logout-btn"
                class="text-xs text-slate-400 hover:text-red-500 transition px-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main>
      <!-- Hero Section -->
      <section class="relative pt-16 pb-32 overflow-hidden">
        <!-- Background decorative elements -->
        <div
          class="absolute top-0 right-0 -mr-20 -mt-20 w-[600px] h-[600px] bg-indigo-50 rounded-full blur-3xl opacity-50 pointer-events-none"
        >
        </div>
        <div
          class="absolute bottom-0 left-0 -ml-20 -mb-20 w-[600px] h-[600px] bg-purple-50 rounded-full blur-3xl opacity-50 pointer-events-none"
        >
        </div>

        <div class="container mx-auto px-6 lg:px-12 max-w-7xl relative z-10">
          <div class="grid lg:grid-cols-2 gap-16 items-center">
            <!-- Left Column: Content & Form -->
            <div class="max-w-2xl mx-auto lg:mx-0 text-center lg:text-left">
              <div
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-50 text-indigo-600 text-sm font-semibold mb-8 border border-indigo-100 animate-fade-in-up"
              >
                <span class="relative flex h-2 w-2">
                  <span
                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"
                  ></span>
                  <span
                    class="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"
                  ></span>
                </span>
                Vision Enhanced
              </div>
              <h1
                class="text-4xl lg:text-6xl font-extrabold text-slate-900 leading-[1.15] mb-6 tracking-tight"
              >
                <span data-i18n="hero_title_1" class="whitespace-nowrap"
                  >The best way to</span
                ><br />
                <span
                  class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600"
                  data-i18n="hero_title_highlight">showcase your project</span
                >
              </h1>
              <p
                data-i18n="description"
                class="text-lg text-slate-600 mb-10 leading-relaxed max-w-lg mx-auto lg:mx-0"
              >
                AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«<span class="text-indigo-600 font-semibold"
                  >ã€Œå¼•ç”¨ã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€</span
                >ã‹ã©ã†ã‹ã‚’è¨ºæ–­ã—ã¾ã™
              </p>

              <!-- Diagnosis Form (Embedded) -->
              <div
                class="bg-white p-2 rounded-2xl shadow-xl shadow-indigo-100 border border-slate-100 max-w-lg mx-auto lg:mx-0 transform transition-all duration-300 hover:shadow-2xl hover:-translate-y-1"
              >
                <form
                  id="diagnosis-form"
                  class="flex flex-col sm:flex-row gap-2 w-full relative"
                >
                  <div class="relative flex-1">
                    <div
                      class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z"
                          clip-rule="evenodd"></path>
                      </svg>
                    </div>
                    <input
                      type="url"
                      id="url-input"
                      name="url"
                      placeholder="https://example.com"
                      required
                      class="w-full pl-11 pr-4 py-3.5 bg-transparent border-none outline-none text-slate-800 placeholder:text-slate-400 h-full rounded-xl focus:bg-slate-50 transition-colors"
                    />
                  </div>
                  <button
                    type="submit"
                    id="submit-btn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-8 py-3.5 rounded-xl transition shadow-lg shadow-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
                    data-i18n="btn_diagnose"
                  >
                    è¨ºæ–­é–‹å§‹
                  </button>
                </form>
              </div>

              <!-- Loading & Error (Placed below form) -->
              <div
                id="loading"
                class="hidden mt-6 text-left max-w-lg mx-auto lg:mx-0 bg-white/50 backdrop-blur-sm p-4 rounded-xl border border-indigo-50"
              >
                <div class="flex items-center gap-3 mb-2">
                  <div
                    class="animate-spin rounded-full h-5 w-5 border-2 border-indigo-600 border-t-transparent"
                  >
                  </div>
                  <p
                    class="text-sm font-bold text-indigo-900"
                    data-i18n="loading_msg"
                  >
                    AIæ¤œç´¢å¯¾ç­–ã‚’ç²¾å¯†è¨ºæ–­ä¸­...
                  </p>
                </div>
                <div class="pl-8 text-xs text-slate-500 space-y-1">
                  <p
                    id="loading-step-1"
                    class="transition-colors duration-300"
                    data-i18n="loading_step1"
                  >
                    ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å–å¾—ä¸­...
                  </p>
                  <p
                    id="loading-step-2"
                    class="opacity-50 transition-colors duration-300"
                    data-i18n="loading_step2"
                  >
                    è¦–è¦šçš„åˆ†æä¸­...
                  </p>
                  <p
                    id="loading-step-3"
                    class="opacity-50 transition-colors duration-300"
                    data-i18n="loading_step3"
                  >
                    ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è©•ä¾¡ä¸­...
                  </p>
                </div>
              </div>

              <div
                id="error"
                class="hidden mt-6 p-3 md:p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 max-w-lg mx-auto lg:mx-0 animate-shake"
              >
              </div>
            </div>

            <!-- Right Column: Image -->
            <div class="relative hidden lg:block perspective-1000">
              <div
                class="relative z-10 transform transition-all duration-700 hover:scale-[1.02]"
              >
                <img
                  src="/images/hero-illustration.png"
                  alt="AI GEO Diagnosis Visualization"
                  class="w-full h-auto drop-shadow-2xl"
                />

                <!-- Floating Badge 1 -->
                <div
                  class="absolute -top-6 -right-6 bg-white p-4 rounded-2xl shadow-xl animate-float-slow hidden xl:block"
                >
                  <div class="flex items-center gap-3">
                    <div
                      class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        ><path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path></svg
                      >
                    </div>
                    <div>
                      <p class="text-xs text-slate-500 font-medium">
                        Optimization
                      </p>
                      <p class="text-lg font-bold text-slate-800">98%</p>
                    </div>
                  </div>
                </div>

                <!-- Floating Badge 2 -->
                <div
                  class="absolute -bottom-8 -left-8 bg-white p-4 rounded-2xl shadow-xl animate-float-medium hidden xl:block"
                >
                  <div class="flex items-center gap-3">
                    <div
                      class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        ><path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg
                      >
                    </div>
                    <div>
                      <p class="text-xs text-slate-500 font-medium">
                        AI Impact
                      </p>
                      <p class="text-lg font-bold text-slate-800">High</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Results Container -->
      <div
        class="container mx-auto px-6 lg:px-12 max-w-7xl -mt-20 relative z-20 pb-20"
      >
        <section id="result" class="hidden space-y-8">
          <!-- Reuse existing content structures inside, but styling will be applied by global classes -->
          <!-- GEOã‚¹ã‚³ã‚¢ -->
          <div
            class="bg-white rounded-3xl shadow-xl p-8 lg:p-10 border border-slate-100"
          >
            <h2
              class="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-3"
            >
              <div class="w-2 h-8 bg-indigo-600 rounded-full"></div>
              <span data-i18n="geo_score">GEOã‚¹ã‚³ã‚¢</span>
            </h2>
            <div class="flex flex-col md:flex-row items-center gap-8">
              <div
                id="score-display"
                class="text-7xl font-black text-indigo-600 tracking-tighter"
              >
                --
              </div>
              <div class="flex-1 w-full">
                <div
                  class="h-6 bg-slate-100 rounded-full overflow-hidden shadow-inner"
                >
                  <div
                    id="score-bar"
                    class="h-full bg-gradient-to-r from-indigo-400 to-purple-600 transition-all duration-1000 ease-out relative"
                    style="width: 0%"
                  >
                    <div class="absolute inset-0 bg-white/20 animate-pulse">
                    </div>
                  </div>
                </div>
                <p
                  class="text-sm text-slate-500 mt-2 font-medium"
                  data-i18n="geo_score_desc"
                >
                  AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«å¼•ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§
                </p>
              </div>
            </div>
            <div
              class="mt-6 p-4 bg-indigo-50/50 border border-indigo-100 rounded-xl"
            >
              <p class="text-sm text-indigo-800 flex items-start gap-3">
                <span>
                  <strong data-i18n="score_warning_title"
                    >ã“ã®ã‚¹ã‚³ã‚¢ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ§‹é€ ã®æœ€é©åº¦ã‚’æ¸¬å®šã—ã¦ã„ã¾ã™ã€‚</strong
                  ><br />
                  <span data-i18n="score_warning_desc" class="opacity-80">
                    ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¨©å¨æ€§ãƒ»è¢«ãƒªãƒ³ã‚¯ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰èªçŸ¥åº¦ã¯è€ƒæ…®ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
                  </span>
                </span>
              </p>
            </div>
          </div>

          <!-- 4è»¸è©³ç´°ã‚¹ã‚³ã‚¢ -->
          <div
            id="scores-detail"
            class="bg-white rounded-3xl shadow-xl p-8 lg:p-10 border border-slate-100 hidden"
          >
            <h2
              class="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-3"
            >
              <div class="w-2 h-8 bg-purple-600 rounded-full"></div>
              <span data-i18n="axes_title">4ã¤ã®è©•ä¾¡è»¸</span>
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 lg:gap-6">
              <!-- Structure -->
              <div
                class="group relative bg-slate-50 hover:bg-white p-6 rounded-2xl transition-all duration-300 hover:shadow-lg border border-transparent hover:border-slate-100"
              >
                <div class="relative z-10">
                  <div
                    class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-2"
                  >
                    Structure
                  </div>
                  <div
                    id="score-structure"
                    class="text-4xl font-black text-slate-900 mb-1"
                  >
                    --
                  </div>
                  <div
                    class="text-xs text-slate-400"
                    data-i18n="desc_structure"
                  >
                    æ§‹é€ ãƒ»å¯èª­æ€§
                  </div>
                </div>
                <div
                  class="absolute top-4 right-4 text-slate-200 group-hover:text-indigo-100 transition-colors"
                >
                  <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"
                    ><path
                      d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm2 0v12h12V6H6z"
                    ></path></svg
                  >
                </div>
              </div>

              <!-- Context -->
              <div
                id="axis-context"
                class="group relative bg-slate-50 hover:bg-white p-6 rounded-2xl transition-all duration-300 hover:shadow-lg border border-transparent hover:border-slate-100"
              >
                <div
                  class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-2"
                >
                  Context
                </div>
                <div
                  id="score-context"
                  class="text-4xl font-black text-slate-900 mb-1"
                >
                  --
                </div>
                <div class="text-xs text-slate-400" data-i18n="desc_context">
                  æ–‡è„ˆãƒ»æ„å‘³
                </div>
                <!-- Mask -->
                <div
                  id="mask-context"
                  class="absolute inset-0 bg-slate-100/80 backdrop-blur-sm rounded-2xl flex items-center justify-center border border-slate-200 hidden"
                >
                  <span class="text-3xl">ğŸ”’</span>
                </div>
              </div>

              <!-- Freshness -->
              <div
                id="axis-freshness"
                class="group relative bg-slate-50 hover:bg-white p-6 rounded-2xl transition-all duration-300 hover:shadow-lg border border-transparent hover:border-slate-100"
              >
                <div
                  class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-2"
                >
                  Freshness
                </div>
                <div
                  id="score-freshness"
                  class="text-4xl font-black text-slate-900 mb-1"
                >
                  --
                </div>
                <div class="text-xs text-slate-400" data-i18n="desc_freshness">
                  é®®åº¦ãƒ»æ›´æ–°
                </div>
                <!-- Mask -->
                <div
                  id="mask-freshness"
                  class="absolute inset-0 bg-slate-100/80 backdrop-blur-sm rounded-2xl flex items-center justify-center border border-slate-200 hidden"
                >
                  <span class="text-3xl">ğŸ”’</span>
                </div>
              </div>

              <!-- Credibility -->
              <div
                id="axis-credibility"
                class="group relative bg-slate-50 hover:bg-white p-6 rounded-2xl transition-all duration-300 hover:shadow-lg border border-transparent hover:border-slate-100"
              >
                <div
                  class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-2"
                >
                  Credibility
                </div>
                <div
                  id="score-credibility"
                  class="text-4xl font-black text-slate-900 mb-1"
                >
                  --
                </div>
                <div
                  class="text-xs text-slate-400"
                  data-i18n="desc_credibility"
                >
                  ä¿¡é ¼æ€§
                </div>
                <!-- Mask -->
                <div
                  id="mask-credibility"
                  class="absolute inset-0 bg-slate-100/80 backdrop-blur-sm rounded-2xl flex items-center justify-center border border-slate-200 hidden"
                >
                  <span class="text-3xl">ğŸ”’</span>
                </div>
              </div>
            </div>

            <!-- Pro Banner -->
            <div
              id="pro-upgrade-banner"
              class="hidden mt-8 rounded-2xl overflow-hidden relative group cursor-pointer"
            >
              <div
                class="absolute inset-0 bg-gradient-to-r from-violet-600 to-indigo-600 transition-all duration-300 group-hover:scale-105"
              >
              </div>
              <div
                class="relative p-5 md:p-8 flex flex-col md:flex-row items-center justify-between gap-6"
              >
                <div class="text-white">
                  <h3 class="text-2xl font-bold mb-2 flex items-center gap-2">
                    <span data-i18n="pro_card_title">Proãƒ—ãƒ©ãƒ³ã§åˆ¶é™ã‚’è§£é™¤</span
                    >
                  </h3>
                  <ul class="mt-2 space-y-2 text-white text-lg font-medium">
                    <li class="flex items-center gap-3">
                      <span class="text-xl">âœ“</span>
                      <span data-i18n="pro_benefit_1">å›æ•°åˆ¶é™ã®è§£é™¤</span>
                    </li>
                    <li class="flex items-center gap-3">
                      <span class="text-xl">âœ“</span>
                      <span data-i18n="pro_benefit_2">è¨ºæ–­ç²¾åº¦å‘ä¸Š</span>
                    </li>
                    <li class="flex items-center gap-3">
                      <span class="text-xl">âœ“</span>
                      <span data-i18n="pro_benefit_3">å…¨ã¦ã®è¨ºæ–­çµæœã‚’è¡¨ç¤º</span
                      >
                    </li>
                  </ul>
                </div>
                <button
                  id="upgrade-btn"
                  class="js-pro-upgrade-btn w-full md:w-auto bg-white text-indigo-600 font-bold px-4 md:px-8 py-3 rounded-xl shadow-lg hover:bg-indigo-50 transition-colors h-auto whitespace-normal leading-tight md:leading-normal text-center"
                >
                  <span data-i18n="btn_pro_plan">Proãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹</span>
                </button>
              </div>
            </div>
          </div>

          <!-- ç·è©• -->
          <div
            class="bg-indigo-50/50 border border-indigo-100 rounded-3xl p-8 text-slate-700 leading-relaxed font-medium"
          >
            <h2
              class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2"
            >
              <span data-i18n="summary_title">ç·è©•</span>
            </h2>
            <p id="result-summary"></p>
          </div>

          <!-- Analysis Content Grid -->
          <div class="flex flex-col gap-8">
            <!-- Strengths -->
            <div
              class="bg-white rounded-3xl shadow-xl p-8 border border-slate-100"
            >
              <h2
                class="text-xl font-bold text-emerald-800 mb-6 flex items-center gap-2"
              >
                <span data-i18n="strengths_title">è©•ä¾¡ã•ã‚Œã‚‹ãƒã‚¤ãƒ³ãƒˆ</span>
              </h2>
              <ul id="result-strengths" class="space-y-4"></ul>
            </div>

            <!-- Issues -->
            <div
              class="bg-white rounded-3xl shadow-xl p-8 border border-slate-100"
            >
              <h2
                class="text-xl font-bold text-amber-800 mb-6 flex items-center gap-2"
              >
                <span data-i18n="issues_title">æ”¹å–„ã™ã¹ããƒã‚¤ãƒ³ãƒˆ</span>
              </h2>
              <div id="result-issues" class="space-y-4"></div>
            </div>
          </div>

          <!-- AI Preview -->
          <div
            class="bg-slate-900 rounded-3xl shadow-2xl p-8 lg:p-10 border border-slate-800 text-slate-300"
          >
            <h2
              class="text-xl font-bold text-white mb-6 flex items-center gap-3"
            >
              <svg
                class="w-6 h-6 text-teal-400"
                fill="currentColor"
                viewBox="0 0 24 24"
                ><path
                  d="M22 10a6 6 0 00-6-6 6 6 0 00-4 1.8A6 6 0 004 4a6 6 0 00-4 6 6 6 0 006 6 6 6 0 006-2.5 6 6 0 006 2.5A6 6 0 0022 10z"
                ></path></svg
              >
              <span data-i18n="preview_title">AIæ¤œç´¢ã§ã®è¡¨ç¤ºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
            </h2>
            <div class="flex gap-6">
              <div
                class="w-10 h-10 rounded-full bg-teal-600 flex items-center justify-center flex-shrink-0 text-white font-bold border-2 border-teal-400"
              >
                AI
              </div>
              <div
                id="result-impression"
                class="bg-slate-800/50 rounded-2xl rounded-tl-none p-6 text-slate-200 leading-relaxed flex-1 border border-slate-700/50"
              >
              </div>
            </div>
          </div>

          <!-- Bottom Actions -->
          <div class="text-center pt-8">
            <button
              id="reset-btn"
              class="bg-white hover:bg-slate-50 text-slate-600 font-medium py-3 px-8 rounded-xl border border-slate-200 shadow-sm transition-all hover:shadow-md"
              data-i18n="btn_reset"
            >
              åˆ¥ã®URLã‚’è¨ºæ–­ã™ã‚‹
            </button>
            <div
              id="remaining-credits"
              class="mt-4 text-sm text-slate-500 hidden"
            >
              <span data-i18n="credits_remain_prefix"
                >ä»Šæœˆã®æ®‹ã‚Šè¨ºæ–­å›æ•°:
              </span>
              <span
                id="remaining-credits-count"
                class="font-bold text-slate-800"></span>
              <span data-i18n="credits_remain_suffix">å›</span>
            </div>
          </div>
        </section>
      </div>

      <!-- Features Section (Simplified) -->
      <section class="max-w-7xl mx-auto px-6 lg:px-12 py-20">
        <div class="grid md:grid-cols-3 gap-8">
          <div
            class="bg-white p-8 rounded-3xl border border-slate-100 shadow-lg hover:shadow-xl transition-shadow"
          >
            <h3
              class="font-bold text-xl mb-3 text-slate-900"
              data-i18n="feat1_title"
            >
              è¦–è¦šçš„ä¿¡é ¼æ€§
            </h3>
            <p class="text-slate-500 leading-relaxed" data-i18n="feat1_desc">
              ãƒ‡ã‚¶ã‚¤ãƒ³ã‚„å›³è§£ã®ã‚ã‹ã‚Šã‚„ã™ã•ã‚’ç”»åƒèªè­˜AIãŒè©•ä¾¡ã€‚
            </p>
          </div>
          <div
            class="bg-white p-8 rounded-3xl border border-slate-100 shadow-lg hover:shadow-xl transition-shadow"
          >
            <h3
              class="font-bold text-xl mb-3 text-slate-900"
              data-i18n="feat2_title"
            >
              å‹•çš„ã‚µã‚¤ãƒˆå¯¾å¿œ
            </h3>
            <p class="text-slate-500 leading-relaxed" data-i18n="feat2_desc">
              SPAã‚„JSæç”»ã‚µã‚¤ãƒˆã‚‚å®Ÿéš›ã®è¡¨ç¤ºé€šã‚Šã«æ­£ç¢ºã«è¨ºæ–­ã€‚
            </p>
          </div>
          <div
            class="bg-white p-8 rounded-3xl border border-slate-100 shadow-lg hover:shadow-xl transition-shadow"
          >
            <h3
              class="font-bold text-xl mb-3 text-slate-900"
              data-i18n="feat3_title"
            >
              å…·ä½“çš„ãªæ”¹å–„æ¡ˆ
            </h3>
            <p class="text-slate-500 leading-relaxed" data-i18n="feat3_desc">
              ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒ»ãƒ©ã‚¤ã‚¿ãƒ¼ãŒå³åº§ã«ä¿®æ­£ã§ãã‚‹æŠ€è¡“çš„æŒ‡æ‘˜ã€‚
            </p>
          </div>
        </div>
      </section>

      <footer
        class="bg-white border-t border-slate-100 py-12 text-center text-slate-500 text-sm"
      >
        <div class="container mx-auto px-6">
          <div class="flex flex-wrap justify-center gap-6 mb-4">
            <a href="/privacy" class="hover:text-indigo-600 transition-colors"
              >Privacy Policy</a
            >
            <a href="/terms" class="hover:text-indigo-600 transition-colors"
              >Terms of Service</a
            >
            <a href="/contact" class="hover:text-indigo-600 transition-colors"
              >Contact</a
            >
          </div>
          <p>&copy; {new Date().getFullYear()} AI GEOè¨ºæ–­ (Vision Enhanced)</p>
        </div>
      </footer>
    </main>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div
    id="login-modal"
    class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
  >
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <h2
        class="text-2xl font-bold text-slate-900 mb-4"
        data-i18n="modal_title"
      >
        ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™
      </h2>
      <p class="text-slate-600 mb-6" data-i18n="modal_desc">
        è¨ºæ–­çµæœã‚’ä¿å­˜ãƒ»é–²è¦§ã™ã‚‹ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
      </p>
      <button
        id="google-login-btn"
        class="w-full flex items-center justify-center gap-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-medium py-3 px-6 rounded-xl transition"
      >
        <svg class="w-5 h-5" viewBox="0 0 24 24">
          <path
            fill="#4285F4"
            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
          ></path>
          <path
            fill="#34A853"
            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
          ></path>
          <path
            fill="#FBBC05"
            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
          ></path>
          <path
            fill="#EA4335"
            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
          ></path>
        </svg>
        <span data-i18n="btn_google_login">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</span>
      </button>
      <button
        id="close-modal-btn"
        class="w-full mt-4 text-slate-500 hover:text-slate-700 text-sm"
        data-i18n="btn_cancel"
      >
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
      <!-- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ®‹æ•°è¡¨ç¤º -->
      <div
        id="credits-info"
        class="hidden mt-4 p-3 bg-indigo-50 rounded-lg text-center"
      >
        <p class="text-sm text-indigo-800">
          æ®‹ã‚Šè¨ºæ–­å›æ•°: <span id="credits-count" class="font-bold">3</span> å›
        </p>
      </div>
    </div>
  </div>

  <!-- ã‚µãƒ–ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div
    id="cancel-confirm-modal"
    class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
  >
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="flex items-center gap-3 mb-4">
        <div
          class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 text-amber-600"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            ></path>
          </svg>
        </div>
        <h2
          class="text-xl font-bold text-slate-900"
          data-i18n="cancel_confirm_title"
        >
          æœ¬å½“ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ
        </h2>
      </div>

      <p class="text-slate-600 mb-4" data-i18n="cancel_confirm_desc">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒå¤±ã‚ã‚Œã¾ã™ï¼š
      </p>

      <div class="bg-red-50 border border-red-100 rounded-xl p-4 mb-6">
        <ul class="space-y-2 text-red-700">
          <li class="flex items-center gap-2">
            <svg
              class="w-5 h-5 flex-shrink-0"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span data-i18n="cancel_lose_1">å›æ•°ç„¡åˆ¶é™ã®è¨ºæ–­</span>
          </li>
          <li class="flex items-center gap-2">
            <svg
              class="w-5 h-5 flex-shrink-0"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span data-i18n="cancel_lose_2">å…¨ã¦ã®è¨ºæ–­çµæœã‚’è¡¨ç¤º</span>
          </li>
          <li class="flex items-center gap-2">
            <svg
              class="w-5 h-5 flex-shrink-0"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span data-i18n="cancel_lose_3">è¨ºæ–­ç²¾åº¦å‘ä¸Š</span>
          </li>
        </ul>
      </div>

      <p class="text-sm text-slate-500 mb-6" data-i18n="cancel_note">
        â€»
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‚‚ã€ç¾åœ¨ã®è«‹æ±‚æœŸé–“çµ‚äº†ã¾ã§ã¯Proæ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚
      </p>

      <div class="flex gap-3">
        <button
          id="cancel-confirm-back-btn"
          class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-3 px-6 rounded-xl transition"
          data-i18n="btn_back"
        >
          æˆ»ã‚‹
        </button>
        <button
          id="cancel-confirm-proceed-btn"
          class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-6 rounded-xl transition"
          data-i18n="btn_proceed_cancel"
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¸é€²ã‚€
        </button>
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ initialLang }}>
    window.__INITIAL_LANG__ = initialLang;
  </script>

  <script>
    import { createClient, SupabaseClient } from "@supabase/supabase-js";
    import DOMPurify from "dompurify";

    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼‰
    const supabaseUrl =
      import.meta.env.PUBLIC_SUPABASE_URL || import.meta.env.SUPABASE_URL || "";
    const supabaseAnonKey =
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY ||
      import.meta.env.SUPABASE_ANON_KEY ||
      "";

    // Supabaseæœªè¨­å®šæ™‚ã¯nullã«ã—ã¦ã‚¹ã‚­ãƒƒãƒ—
    let supabase: SupabaseClient | null = null;
    if (supabaseUrl && supabaseAnonKey) {
      supabase = createClient(supabaseUrl, supabaseAnonKey);
    } else {
      console.error(
        "Supabase API keys are missing. Please check your .env file.",
      );
    }

    // èªè¨¼çŠ¶æ…‹
    let currentUser: any = null;
    let pendingUrl: string | null = null;

    // DOMè¦ç´ 
    const form = document.getElementById("diagnosis-form") as HTMLFormElement;
    const urlInput = document.getElementById("url-input") as HTMLInputElement;
    const submitBtn = document.getElementById(
      "submit-btn",
    ) as HTMLButtonElement;
    const loading = document.getElementById("loading") as HTMLDivElement;
    const error = document.getElementById("error") as HTMLDivElement;
    const result = document.getElementById("result") as HTMLElement;
    const resetBtn = document.getElementById("reset-btn") as HTMLButtonElement;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
    const loginModal = document.getElementById("login-modal") as HTMLDivElement;
    const googleLoginBtn = document.getElementById(
      "google-login-btn",
    ) as HTMLButtonElement;
    const closeModalBtn = document.getElementById(
      "close-modal-btn",
    ) as HTMLButtonElement;
    const creditsInfo = document.getElementById(
      "credits-info",
    ) as HTMLDivElement;
    const creditsCount = document.getElementById(
      "credits-count",
    ) as HTMLSpanElement;

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ†ãƒƒãƒ—è¦ç´ 
    const loadingStep1 = document.getElementById(
      "loading-step-1",
    ) as HTMLParagraphElement;
    const loadingStep2 = document.getElementById(
      "loading-step-2",
    ) as HTMLParagraphElement;
    const loadingStep3 = document.getElementById(
      "loading-step-3",
    ) as HTMLParagraphElement;

    // è¨€èªè¨­å®šï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§æ¤œå‡ºã—ãŸåˆæœŸè¨€èªã‚’ä½¿ç”¨ï¼‰
    let currentLang: "ja" | "en" = ((window as any).__INITIAL_LANG__ ||
      "ja") as "ja" | "en";
    const translations = {
      ja: {
        title: "AI GEOè¨ºæ–­",
        hero_title_1: "AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³æ™‚ä»£ã®",
        hero_title_highlight: "æ–°ã—ã„SEOå¯¾ç­–",
        description: `AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«<span class="text-indigo-600 font-semibold">ã€Œå¼•ç”¨ã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€</span>ã‹ã©ã†ã‹ã‚’è¨ºæ–­ã—ã¾ã™`,
        label_url: "è¨ºæ–­ã—ãŸã„URLã‚’å…¥åŠ›",
        btn_diagnose: "GEOè¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹",
        loading_msg: "AIæ¤œç´¢å¯¾ç­–ã‚’ç²¾å¯†è¨ºæ–­ä¸­...ï¼ˆ1ã€œ2åˆ†ç¨‹åº¦ï¼‰",
        loading_step1: "ğŸ–¥ï¸ ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ä¸­...",
        loading_step2: "ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã—ã¦è¦–è¦šåˆ†æä¸­...",
        loading_step3: "ğŸ¤– AIã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§è©•ä¾¡ä¸­...",
        geo_score: "GEOã‚¹ã‚³ã‚¢",
        geo_score_desc: "AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«å¼•ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§",
        suggestion_prefix: "ğŸ’¡ æ”¹å–„ææ¡ˆ:",
        impact_high: "å½±éŸ¿: å¤§",
        impact_medium: "å½±éŸ¿: ä¸­",
        impact_low: "å½±éŸ¿: å°",
        pro_lock: "ğŸ”’ Proãƒ—ãƒ©ãƒ³ã§è©³ç´°ã‚’è¡¨ç¤º",
        score_structure: "Structure (æ§‹é€ )",
        score_context: "Context (æ–‡è„ˆ)",
        score_freshness: "Freshness (é®®åº¦)",
        score_credibility: "Credibility (ä¿¡é ¼æ€§)",

        desc_structure: "æ§‹é€ ãƒ»æ©Ÿæ¢°å¯èª­æ€§",
        desc_context: "æ–‡è„ˆãƒ»æ„å‘³ç†è§£",
        desc_freshness: "æƒ…å ±ã®é®®åº¦",
        desc_credibility: "ä¿¡é ¼æ€§ã‚·ã‚°ãƒŠãƒ«",
        metric_b: "æŒ‡æ¨™B",
        metric_c: "æŒ‡æ¨™C",
        metric_d: "æŒ‡æ¨™D",
        pro_banner_title: "ğŸ”’ AIã«è¦‹è½ã¨ã•ã‚Œã‚‹è‡´å‘½çš„ãªåŸå› ãŒã‚ã‚Šã¾ã™",
        pro_banner_desc:
          "Proãƒ—ãƒ©ãƒ³ã§3ã¤ã®è¬ã®æŒ‡æ¨™ã‚’è§£é™¤ã—ã€ã™ã¹ã¦ã®æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚",
        btn_pro_plan: "Proãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹ï¼ˆæœˆé¡1,980å††ï¼‰",
        no_strengths_found: "ç‰¹ã«è©•ä¾¡ã•ã‚Œã‚‹ãƒã‚¤ãƒ³ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚",
        no_issues_found: "ç‰¹ã«æ”¹å–„ã™ã¹ããƒã‚¤ãƒ³ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚",
        login_suggest: "ãƒ­ã‚°ã‚¤ãƒ³",
        feat1_title: "è¦–è¦šçš„ä¿¡é ¼æ€§ã‚’åˆ†æ",
        feat1_desc:
          "Visionï¼ˆç”»åƒèªè­˜ï¼‰æ©Ÿèƒ½ã§ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã‚„å›³è§£ã®ã‚ã‹ã‚Šã‚„ã™ã•ã‚‚è©•ä¾¡ã€‚",
        feat2_title: "å‹•çš„ã‚µã‚¤ãƒˆå®Œå…¨å¯¾å¿œ",
        feat2_desc: "JSã§æç”»ã•ã‚Œã‚‹SPAã‚µã‚¤ãƒˆã‚‚ã€å®Ÿéš›ã®è¡¨ç¤ºé€šã‚Šã«æ­£ç¢ºã«è¨ºæ–­ã€‚",
        feat3_title: "å…·ä½“çš„ãªæ”¹å–„æŒ‡ç¤º",
        feat3_desc:
          "ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒ»ãƒ©ã‚¤ã‚¿ãƒ¼å‘ã‘ã«å³åº§ã«ä¿®æ­£ã§ãã‚‹æŠ€è¡“çš„æŒ‡æ‘˜ã‚’æä¾›ã€‚",
        credits_remain_prefix: "ä»Šæœˆã®æ®‹ã‚Šè¨ºæ–­å›æ•°: ",
        credits_remain_suffix: "å›",
        btn_reset: "åˆ¥ã®URLã‚’è¨ºæ–­ã™ã‚‹",
        modal_title: "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™",
        modal_desc:
          "è¨ºæ–­çµæœã‚’ä¿å­˜ãƒ»é–²è¦§ã™ã‚‹ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚",
        btn_google_login: "Googleã§ãƒ­ã‚°ã‚¤ãƒ³",
        btn_cancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
        logout: "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ",
        score_warning_title:
          "ã“ã®ã‚¹ã‚³ã‚¢ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ§‹é€ ã®æœ€é©åº¦ã‚’æ¸¬å®šã—ã¦ã„ã¾ã™ã€‚",
        score_warning_desc:
          "ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¨©å¨æ€§ãƒ»è¢«ãƒªãƒ³ã‚¯ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰èªçŸ¥åº¦ã¯è€ƒæ…®ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å¤§æ‰‹ã‚µã‚¤ãƒˆï¼ˆRedditã€Wikipediaç­‰ï¼‰ã¯æ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¦ã„ãªãã¦ã‚‚AIã«å¼•ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚",
        axes_title: "4ã¤ã®è©•ä¾¡è»¸",
        summary_title: "ç·è©•",
        strengths_title: "AIã«è©•ä¾¡ã•ã‚Œã‚‹ãƒã‚¤ãƒ³ãƒˆ",
        issues_title: "å¼•ç”¨æ©Ÿä¼šã‚’æãªã†ãƒã‚¤ãƒ³ãƒˆ",
        preview_title: "AIæ¤œç´¢ã§ã®è¡¨ç¤ºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼",
        credits_exhausted_msg:
          "ä»Šæœˆã®ç„¡æ–™è¨ºæ–­å›æ•°ï¼ˆ3å›ï¼‰ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸã€‚Proãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹ã¨ç„¡åˆ¶é™ã«è¨ºæ–­ã§ãã¾ã™ã€‚",
        btn_upgrade_error: "Proãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰",
        pro_card_title: "Proãƒ—ãƒ©ãƒ³ã§åˆ¶é™ã‚’è§£é™¤",
        pro_card_subtitle: "AIæ¤œç´¢æœ€é©åŒ–ã‚’åŠ é€Ÿã•ã›ã‚‹å¼·åŠ›ãªæ©Ÿèƒ½",
        pro_benefit_1: "å›æ•°åˆ¶é™ã®è§£é™¤",
        pro_benefit_2: "è¨ºæ–­ç²¾åº¦å‘ä¸Š",
        pro_benefit_3: "å…¨ã¦ã®è¨ºæ–­çµæœã‚’è¡¨ç¤º",
        benefit_unlimited_title: "å›æ•°ç„¡åˆ¶é™",
        benefit_unlimited_desc: "å¿ƒã‚†ãã¾ã§ä½•åº¦ã§ã‚‚è¨ºæ–­ãƒ»æ”¹å–„ã‚’è©¦ã›ã¾ã™",
        benefit_accuracy_title: "ç²¾åº¦å‘ä¸Š",
        benefit_accuracy_desc: "ã‚ˆã‚Šè©³ç´°ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§æ·±ã„åˆ†æãŒå¯èƒ½ã«",
        benefit_advice_title: "å…¨ã¦ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç¢ºèª",
        benefit_advice_desc: "è§£æ±ºç­–ã‚’å«ã‚€è©³ç´°ãªæ”¹å–„æŒ‡ç¤ºã‚’å®Œå…¨è¡¨ç¤º",
        cancel_anytime: "ã„ã¤ã§ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½",
        manage_subscription: "ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†",
        cancel_confirm_title: "æœ¬å½“ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ",
        cancel_confirm_desc: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒå¤±ã‚ã‚Œã¾ã™ï¼š",
        cancel_lose_1: "å›æ•°ç„¡åˆ¶é™ã®è¨ºæ–­",
        cancel_lose_2: "å…¨ã¦ã®è¨ºæ–­çµæœã‚’è¡¨ç¤º",
        cancel_lose_3: "è¨ºæ–­ç²¾åº¦å‘ä¸Š",
        cancel_note:
          "â€» ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‚‚ã€ç¾åœ¨ã®è«‹æ±‚æœŸé–“çµ‚äº†ã¾ã§ã¯Proæ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚",
        btn_back: "æˆ»ã‚‹",
        btn_proceed_cancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¸é€²ã‚€",
      },
      en: {
        title: "AI GEO Diagnosis",
        hero_title_1: "The New Standard for",
        hero_title_highlight: "AI Search Optimization",
        description: `Check if your content is cited by <span class="text-indigo-600 font-semibold">AI Search Engines</span>`,
        label_url: "Enter URL to analyze",
        btn_diagnose: "Start Diagnosis",
        loading_msg:
          "Analyzing for AI Search Optimization... (approx. 1-2 mins)",
        loading_step1: "ğŸ–¥ï¸ Fetching content with headless browser...",
        loading_step2: "ğŸ“¸ Analyzing visual elements (screenshots)...",
        loading_step3: "ğŸ¤– Evaluating with AI algorithms...",
        geo_score: "GEO Score",
        geo_score_desc: "Probability of being cited by AI Search Engines",
        suggestion_prefix: "ğŸ’¡ Suggestion:",
        impact_high: "Impact: High",
        impact_medium: "Impact: Medium",
        impact_low: "Impact: Low",
        pro_lock: "ğŸ”’ Unlock with Pro",
        score_structure: "Structure",
        score_context: "Context",
        score_freshness: "Freshness",
        score_credibility: "Credibility",

        desc_structure: "Schema & Machine Readability",
        desc_context: "Context & Semantic Understanding",
        desc_freshness: "Freshness & Updates",
        desc_credibility: "Credibility Signals",
        metric_b: "Metric B",
        metric_c: "Metric C",
        metric_d: "Metric D",
        pro_banner_title: "ğŸ”’ Critical issues detected",
        pro_banner_desc:
          "Unlock all 4 metrics and full improvement advice with Pro Plan.",
        btn_pro_plan: "Get Pro Plan ($14.99/mo)",
        no_strengths_found: "No specific strengths found.",
        no_issues_found: "No specific issues found.",
        login_suggest: "Login",
        feat1_title: "Visual Reliability Analysis",
        feat1_desc:
          "Evaluate design clarity using Vision (image recognition) capabilities.",
        feat2_title: "Full Dynamic Site Support",
        feat2_desc:
          "Accurately diagnose JS-rendered SPA sites exactly as they appear.",
        feat3_title: "Specific Actionable Advice",
        feat3_desc:
          "Provide technical feedback that engineers and writers can fix immediately.",
        credits_remain_prefix: "Monthly Credits Remaining: ",
        credits_remain_suffix: " times",
        btn_reset: "Analyze Another URL",
        modal_title: "Login Required",
        modal_desc:
          "Please log in with your Google account to save and view diagnostic results.",
        btn_google_login: "Sign in with Google",
        btn_cancel: "Cancel",
        logout: "Log out",
        score_warning_title:
          "This score measures content structure optimization.",
        score_warning_desc:
          "Domain authority, backlinks, and brand recognition are NOT considered. Major sites (Reddit, Wikipedia, etc.) may be cited by AI even without optimized structure.",
        axes_title: "4 Evaluation Axes",
        summary_title: "Overall Summary",
        strengths_title: "Points Evaluated by AI",
        issues_title: "Points Losing Citation Opportunities",
        preview_title: "AI Search Preview",
        credits_exhausted_msg:
          "You have used up your monthly free credits (3). Upgrade to Pro for unlimited diagnosis.",
        btn_upgrade_error: "Upgrade to Pro Plan",
        pro_card_title: "Unlock Pro Features",
        pro_card_subtitle:
          "Powerful features to accelerate AI Search Optimization",
        pro_benefit_1: "Unlimited Usage",
        pro_benefit_2: "Improved Accuracy",
        pro_benefit_3: "View All Results",
        benefit_unlimited_title: "Unlimited Diagnosis",
        benefit_unlimited_desc: "Analyze and improve as many times as you want",
        benefit_accuracy_title: "Improved Accuracy",
        benefit_accuracy_desc: "Deeper analysis with detailed algorithms",
        benefit_advice_title: "View All Advice",
        benefit_advice_desc: "Full access to detailed improvement instructions",
        cancel_anytime: "Cancel anytime",
        manage_subscription: "Manage Plan",
        cancel_confirm_title: "Cancel your subscription?",
        cancel_confirm_desc: "You will lose access to the following features:",
        cancel_lose_1: "Unlimited diagnoses",
        cancel_lose_2: "View all diagnostic results",
        cancel_lose_3: "Improved accuracy",
        cancel_note:
          "* You can continue using Pro features until the end of your current billing period.",
        btn_back: "Go Back",
        btn_proceed_cancel: "Proceed to Cancel",
      },
    };

    function setLanguage(lang: "ja" | "en") {
      currentLang = lang;

      // ãƒœã‚¿ãƒ³UIæ›´æ–°
      const btnJa = document.getElementById("lang-btn-ja");
      const btnEn = document.getElementById("lang-btn-en");
      const activeClass =
        "px-4 py-1.5 rounded-md text-sm font-bold bg-white text-indigo-600 shadow-sm transition-all pointer-events-auto z-10";
      const inactiveClass =
        "px-4 py-1.5 rounded-md text-sm font-medium text-slate-500 hover:text-indigo-600 transition-all pointer-events-auto z-10";

      if (btnJa && btnEn) {
        if (lang === "ja") {
          btnJa.className = activeClass;
          btnEn.className = inactiveClass;
        } else {
          btnJa.className = inactiveClass;
          btnEn.className = activeClass;
        }
      }

      // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
      const t = translations[lang] as any;
      const elements = document.querySelectorAll("[data-i18n]");
      elements.forEach((el) => {
        const key = el.getAttribute("data-i18n");
        if (key && t[key]) {
          if (key === "description") {
            el.innerHTML = t[key];
          } else {
            el.textContent = t[key];
          }
        }
      });

      // ãƒãƒƒã‚¸è¡¨ç¤ºæ›´æ–°
      if (typeof updateBadgeUI === "function") {
        updateBadgeUI();
      }
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´ 
    const headerLoginBtn = document.getElementById("header-login-btn");
    const headerUserInfo = document.getElementById("header-user-info");
    const headerLogoutBtn = document.getElementById("header-logout-btn");
    const userEmailEl = document.getElementById("user-email");
    const creditBadge = document.getElementById("credit-badge");

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
    let userProfile: any = null;

    // ãƒãƒƒã‚¸UIæ›´æ–°
    function updateBadgeUI() {
      if (!creditBadge) return;

      const manageSubBtn = document.getElementById("manage-subscription-btn");

      if (userProfile) {
        if (userProfile.is_premium) {
          creditBadge.textContent =
            currentLang === "en" ? "Pro Plan" : "Proãƒ—ãƒ©ãƒ³ (ç„¡åˆ¶é™)";
          creditBadge.className =
            "inline-block text-[10px] bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-2 py-0.5 rounded-full";
          // Proãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          if (manageSubBtn) {
            manageSubBtn.classList.remove("hidden");
            manageSubBtn.title =
              currentLang === "en" ? "Manage Plan" : "ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†";
          }
        } else {
          const prefix = currentLang === "en" ? "Credits: " : "æ®‹ã‚Š: ";
          const suffix = currentLang === "en" ? "" : "å›";
          creditBadge.textContent = `${prefix}${userProfile.free_credits}${suffix}`;
          creditBadge.className =
            "inline-block text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full";
          // éProãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
          if (manageSubBtn) {
            manageSubBtn.classList.add("hidden");
          }
        }
      } else {
        // æœªãƒ­ãƒ¼ãƒ‰æ™‚ã¾ãŸã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚
        creditBadge.textContent =
          currentLang === "en" ? "Credits: -" : "æ®‹ã‚Š: -å›";
        if (manageSubBtn) {
          manageSubBtn.classList.add("hidden");
        }
      }
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­ãƒ•ãƒ©ã‚°ï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œå›é¿ï¼‰
    let isLoggingOut = false;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
    async function fetchUserProfile() {
      if (!supabase || !currentUser || isLoggingOut) return;

      try {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        if (!session?.access_token) return;

        const response = await fetch("/api/me", {
          headers: {
            Authorization: `Bearer ${session.access_token}`,
          },
        });

        if (response.ok) {
          userProfile = await response.json();
          updateBadgeUI();
        } else if (response.status === 401) {
          // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹æ™‚ã¯é™ã‹ã«ç„¡è¦–
          console.log("Session invalid, skipping profile fetch");
        }
      } catch (e) {
        console.error("Failed to fetch profile", e);
      }
    }

    // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
    async function checkAuth() {
      if (!supabase) return null;
      const {
        data: { session },
      } = await supabase.auth.getSession();
      currentUser = session?.user ?? null;
      updateHeaderUI();
      if (currentUser) {
        console.log("Logged in as:", currentUser.email);
        fetchUserProfile();
      }
      return currentUser;
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼UIæ›´æ–°
    function updateHeaderUI() {
      if (currentUser) {
        headerLoginBtn?.classList.add("hidden");
        headerUserInfo?.classList.remove("hidden");
        headerUserInfo?.classList.add("flex");
        if (userEmailEl) userEmailEl.textContent = currentUser.email || "";
        // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ fetchUserProfile ã§éåŒæœŸã«æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯åˆæœŸå€¤ã®ã¾ã¾ã«ã—ãªã„
        // ãŸã ã—ã€ã¡ã‚‰ã¤ãé˜²æ­¢ã®ãŸã‚ã«ä½•ã‚‚ã—ãªã„ã‹ã€èª­ã¿è¾¼ã¿ä¸­ã‚’è¡¨ç¤ºã™ã‚‹
      } else {
        headerLoginBtn?.classList.remove("hidden");
        headerUserInfo?.classList.add("hidden");
        headerUserInfo?.classList.remove("flex");
        if (creditBadge) creditBadge.textContent = "æ®‹ã‚Š: -å›";
      }
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    async function logout() {
      if (!supabase) return;
      isLoggingOut = true;

      try {
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆï¼ˆã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼‰
        const { error } = await supabase.auth.signOut({ scope: "global" });
        if (error) {
          console.error("Sign out error:", error);
        }
      } catch (e) {
        console.error("Sign out exception:", e);
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®Supabaseã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ã‚¯ãƒªã‚¢
      const storageKey = `sb-${new URL(supabaseUrl).hostname.split(".")[0]}-auth-token`;
      localStorage.removeItem(storageKey);

      currentUser = null;
      userProfile = null;
      updateBadgeUI();
      updateHeaderUI();

      // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢ã‚’ç¢ºå®Ÿã«ã™ã‚‹ï¼‰
      setTimeout(() => {
        window.location.reload();
      }, 100);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º/éè¡¨ç¤º
    function showLoginModal() {
      loginModal.classList.remove("hidden");
      loginModal.classList.add("flex");
    }

    function hideLoginModal() {
      loginModal.classList.add("hidden");
      loginModal.classList.remove("flex");
    }

    // Googleãƒ­ã‚°ã‚¤ãƒ³
    async function loginWithGoogle() {
      if (!supabase) {
        alert("Supabase client not initialized");
        return;
      }
      try {
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "google",
          options: {
            redirectTo: window.location.origin,
          },
        });
        if (error) {
          console.error("Login error:", error);
          alert("Login error: " + error.message);
        }
      } catch (e: any) {
        console.error("Login exception:", e);
        alert("Login exception: " + (e?.message || String(e)));
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    googleLoginBtn?.addEventListener("click", loginWithGoogle);
    closeModalBtn?.addEventListener("click", hideLoginModal);
    loginModal?.addEventListener("click", (e) => {
      if (e.target === loginModal) hideLoginModal();
    });
    headerLoginBtn?.addEventListener("click", showLoginModal);
    headerLogoutBtn?.addEventListener("click", logout);

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
    const cancelConfirmModal = document.getElementById("cancel-confirm-modal");

    function showCancelConfirmModal() {
      cancelConfirmModal?.classList.remove("hidden");
      cancelConfirmModal?.classList.add("flex");
    }

    function hideCancelConfirmModal() {
      cancelConfirmModal?.classList.add("hidden");
      cancelConfirmModal?.classList.remove("flex");
    }

    // ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ãƒœã‚¿ãƒ³ â†’ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    document
      .getElementById("manage-subscription-btn")
      ?.addEventListener("click", () => {
        if (!supabase || !currentUser) {
          alert(
            currentLang === "en"
              ? "Please log in first"
              : "å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„",
          );
          return;
        }
        showCancelConfirmModal();
      });

    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°: æˆ»ã‚‹ãƒœã‚¿ãƒ³
    document
      .getElementById("cancel-confirm-back-btn")
      ?.addEventListener("click", hideCancelConfirmModal);

    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°: èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    cancelConfirmModal?.addEventListener("click", (e) => {
      if (e.target === cancelConfirmModal) hideCancelConfirmModal();
    });

    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°: ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¸é€²ã‚€ãƒœã‚¿ãƒ³
    document
      .getElementById("cancel-confirm-proceed-btn")
      ?.addEventListener("click", async () => {
        const proceedBtn = document.getElementById(
          "cancel-confirm-proceed-btn",
        ) as HTMLButtonElement | null;
        const originalText = proceedBtn?.innerHTML;

        if (proceedBtn) {
          proceedBtn.disabled = true;
          proceedBtn.innerHTML =
            currentLang === "en"
              ? '<span class="inline-block animate-spin mr-2">â†»</span>Processing...'
              : '<span class="inline-block animate-spin mr-2">â†»</span>å‡¦ç†ä¸­...';
        }

        try {
          const {
            data: { session },
          } = await supabase!.auth.getSession();
          if (!session?.access_token) {
            throw new Error("No session");
          }

          const response = await fetch("/api/customer-portal", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${session.access_token}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to open portal");
          }

          const { url } = await response.json();
          if (url) {
            window.location.href = url;
          }
        } catch (e: any) {
          console.error("Customer portal error:", e);
          alert(
            currentLang === "en"
              ? "Failed to open subscription management: " +
                  (e?.message || String(e))
              : "ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: " + (e?.message || String(e)),
          );
        } finally {
          if (proceedBtn && originalText) {
            proceedBtn.disabled = false;
            proceedBtn.innerHTML = originalText;
          }
        }
      });

    document
      .getElementById("lang-btn-ja")
      ?.addEventListener("click", () => setLanguage("ja"));
    document
      .getElementById("lang-btn-en")
      ?.addEventListener("click", () => setLanguage("en"));

    // èªè¨¼çŠ¶æ…‹å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼
    if (supabase) {
      supabase.auth.onAuthStateChange(async (event, session) => {
        currentUser = session?.user ?? null;

        if (event === "SIGNED_OUT") {
          userProfile = null;
          updateBadgeUI();
        }

        updateHeaderUI();
        if (currentUser) fetchUserProfile();

        if (event === "SIGNED_IN" && session?.user) {
          hideLoginModal();
          // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ä¿ç•™ä¸­ã®URLãŒã‚ã‚Œã°è‡ªå‹•è¨ºæ–­
          if (pendingUrl) {
            const url = pendingUrl;
            pendingUrl = null;
            urlInput.value = url;
            form.dispatchEvent(new Event("submit"));
          }
        }
      });
    }

    // åˆæœŸåŒ–
    checkAuth();
    // åˆæœŸè¨€èªè¨­å®šã‚’UIã«åæ˜ 
    setLanguage(currentLang);

    // Proãƒ—ãƒ©ãƒ³ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    async function handleUpgradeClick(btnElement?: HTMLButtonElement) {
      // ç‰¹å®šã®ãƒœã‚¿ãƒ³ãŒæ¸¡ã•ã‚Œãªã‹ã£ãŸå ´åˆã¯ #upgrade-btn ã‚’æ¢ã™ (å¾Œæ–¹äº’æ›)
      const upgradeBtn =
        btnElement ||
        (document.getElementById("upgrade-btn") as HTMLButtonElement | null);
      const originalText = upgradeBtn?.innerHTML;

      if (upgradeBtn) {
        upgradeBtn.disabled = true;
        upgradeBtn.innerHTML =
          currentLang === "en"
            ? '<span class="inline-block animate-spin mr-2">â†»</span>Processing...'
            : '<span class="inline-block animate-spin mr-2">â†»</span>å‡¦ç†ä¸­...';
      }

      try {
        // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        let authHeaders: Record<string, string> = {
          "Content-Type": "application/json",
        };
        if (supabase && currentUser) {
          const {
            data: { session },
          } = await supabase.auth.getSession();
          if (session?.access_token) {
            authHeaders["Authorization"] = `Bearer ${session.access_token}`;
          }
        }

        const response = await fetch("/api/checkout", {
          method: "POST",
          headers: authHeaders,
          body: JSON.stringify({
            language: currentLang,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || "Failed to initiate checkout");
        }

        if (data.url) {
          window.location.href = data.url;
        }
      } catch (err) {
        console.error("Checkout error:", err);
        alert(
          currentLang === "en"
            ? "An error occurred. Please try again."
            : "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
        );
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        if (upgradeBtn) {
          upgradeBtn.disabled = false;
          if (originalText) upgradeBtn.innerHTML = originalText;
        }
      }
    }

    // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ™‚ãªã©ã«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    window.addEventListener("pageshow", (event) => {
      // BFCacheã‹ã‚‰å¾©å¸°ã—ãŸå ´åˆã¯èªè¨¼çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
      if (event.persisted) {
        checkAuth();
      }
      // ãƒ˜ãƒƒãƒ€ãƒ¼UIçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      updateHeaderUI();

      const upgradeBtn = document.getElementById(
        "upgrade-btn",
      ) as HTMLButtonElement | null;
      if (upgradeBtn) {
        upgradeBtn.disabled = false;
        // è¨€èªè¨­å®šã‚’å†é©ç”¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’å…ƒã«æˆ»ã™
        setLanguage(currentLang as "ja" | "en");
      }

      // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºå†…ã®ãƒœã‚¿ãƒ³ã‚‚ãƒªã‚»ãƒƒãƒˆ
      const errorUpgradeBtn = document.getElementById(
        "upgrade-from-error",
      ) as HTMLButtonElement | null;
      if (errorUpgradeBtn) {
        errorUpgradeBtn.disabled = false;
        errorUpgradeBtn.disabled = false;
        errorUpgradeBtn.innerHTML = (translations as any)[
          currentLang
        ].btn_upgrade_error;
      }
    });

    // æ—¢å­˜ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã«ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š (ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã«å¤‰æ›´)
    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      // IDã¾ãŸã¯ã‚¯ãƒ©ã‚¹ã§åˆ¤å®š
      const upgradeBtn =
        target.closest("#upgrade-btn") || target.closest(".js-pro-upgrade-btn");
      if (upgradeBtn) {
        handleUpgradeClick(upgradeBtn as HTMLButtonElement);
      }
    });

    // Proãƒ—ãƒ©ãƒ³ãƒãƒŠãƒ¼ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    document
      .getElementById("pro-upgrade-banner")
      ?.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        const btn = document.getElementById("upgrade-btn");
        // ãƒœã‚¿ãƒ³ãã®ã‚‚ã®ã‚„å†…éƒ¨ã®ã‚¯ãƒªãƒƒã‚¯ã§ãªã„å ´åˆã®ã¿ç™ºç«ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
        if (
          btn &&
          !target.closest("#upgrade-btn") &&
          !target.closest(".js-pro-upgrade-btn")
        ) {
          btn.click();
        }
      });

    // Proãƒ—ãƒ©ãƒ³ã¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆå‹•çš„ç”Ÿæˆè¦ç´ ç”¨ï¼‰
    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      if (target.closest(".js-pro-lock-overlay")) {
        document
          .getElementById("pro-upgrade-banner")
          ?.scrollIntoView({ behavior: "smooth" });
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const url = urlInput.value.trim();
      if (!url) return;

      // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆSupabaseæœªè¨­å®šæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      if (supabaseUrl && supabaseAnonKey && !currentUser) {
        pendingUrl = url;
        showLoginModal();
        return;
      }

      // UIæ›´æ–°
      submitBtn.disabled = true;
      loading.classList.remove("hidden");
      error.classList.add("hidden");
      result.classList.add("hidden");

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      animateLoading();

      try {
        // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆï¼‰
        let authHeaders: Record<string, string> = {
          "Content-Type": "application/json",
        };
        if (supabase && currentUser) {
          const {
            data: { session },
          } = await supabase.auth.getSession();
          if (session?.access_token) {
            authHeaders["Authorization"] = `Bearer ${session.access_token}`;
          }
        }

        const response = await fetch("/api/diagnose", {
          method: "POST",
          headers: authHeaders,
          body: JSON.stringify({ url, language: currentLang }),
        });

        // 401ã‚¨ãƒ©ãƒ¼ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ï¼‰ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        if (response.status === 401) {
          pendingUrl = url;
          showLoginModal();
          throw new Error("LOGIN_REQUIRED");
        }

        const data = await response.json();

        if (!response.ok) {
          // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆ‡ã‚Œã®å ´åˆã¯ç‰¹åˆ¥ãªUIè¡¨ç¤º
          if (data.credits_exhausted) {
            const t = (translations as any)[currentLang];
            const proCard = document.getElementById(
              "pro-upgrade-banner",
            ) as HTMLDivElement;

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            let errorContent = `
              <div class="text-center mb-8">
                <p class="font-bold mb-4 text-xl text-indigo-900" data-i18n="credits_exhausted_msg">${t.credits_exhausted_msg}</p>
              </div>
            `;

            // Proã‚«ãƒ¼ãƒ‰ã®è¤‡è£½ã¨è¿½åŠ 
            error.innerHTML = errorContent;

            if (proCard) {
              const clone = proCard.cloneNode(true) as HTMLDivElement;
              clone.classList.remove("hidden");
              clone.removeAttribute("id"); // IDé‡è¤‡å›é¿
              clone.classList.add("not-hidden-force"); // å¼·åˆ¶è¡¨ç¤ºç”¨ã®ã‚¯ãƒ©ã‚¹ï¼ˆå¿…è¦ãªã‚‰ï¼‰
              error.appendChild(clone);
            } else {
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ï¼ˆä¸‡ãŒä¸€ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼‰
              error.innerHTML += `
                <div class="text-center">
                  <button id="upgrade-from-error" class="js-pro-upgrade-btn mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    ${t.btn_upgrade_error}
                  </button>
                </div>`;
            }

            error.classList.remove("hidden");
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯documentãƒ¬ãƒ™ãƒ«ã®å§”è­²ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚å†è¨­å®šä¸è¦
            return;
          }
          throw new Error(
            data.error ||
              (currentLang === "en"
                ? "Diagnosis failed"
                : "è¨ºæ–­ã«å¤±æ•—ã—ã¾ã—ãŸ"),
          );
        }

        displayResult(data);
      } catch (err) {
        // ãƒ­ã‚°ã‚¤ãƒ³èª˜å°æ™‚ã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã—ãªã„
        if (err instanceof Error && err.message === "LOGIN_REQUIRED") {
          return;
        }

        error.textContent =
          err instanceof Error
            ? err.message
            : currentLang === "en"
              ? "An error occurred during diagnosis"
              : "è¨ºæ–­ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
        error.classList.remove("hidden");
      } finally {
        submitBtn.disabled = false;
        loading.classList.add("hidden");
      }
    });

    function animateLoading() {
      // 3ç§’ã”ã¨ã«ã‚¹ãƒ†ãƒƒãƒ—ã‚’é€²ã‚ã‚‹æ“¬ä¼¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      loadingStep1.className =
        "font-bold text-indigo-600 transition-all duration-500";
      loadingStep2.className = "opacity-50 transition-all duration-500";
      loadingStep3.className = "opacity-50 transition-all duration-500";

      setTimeout(() => {
        loadingStep1.className = "text-green-600 transition-all duration-500"; // å®Œäº†
        loadingStep2.className =
          "font-bold text-indigo-600 transition-all duration-500";
      }, 5000);

      setTimeout(() => {
        loadingStep2.className = "text-green-600 transition-all duration-500"; // å®Œäº†
        loadingStep3.className =
          "font-bold text-indigo-600 transition-all duration-500";
      }, 15000);
    }

    resetBtn.addEventListener("click", () => {
      result.classList.add("hidden");
      urlInput.value = "";
      urlInput.focus();
    });

    function displayResult(data: {
      summary: string;
      geo_score: number;
      is_premium?: boolean;
      free_credits?: number;
      scores?: {
        structure: number;
        context: number;
        freshness: number;
        credibility: number;
      };
      strengths: string[];
      issues: {
        title: string;
        description: string;
        impact: string;
        category?: string;
        suggestion?: string;
      }[];
      impression: string;
    }) {
      // GEOã‚¹ã‚³ã‚¢
      const scoreDisplay = document.getElementById(
        "score-display",
      ) as HTMLDivElement;
      const scoreBar = document.getElementById("score-bar") as HTMLDivElement;
      scoreDisplay.textContent = String(data.geo_score);
      scoreBar.style.width = `${data.geo_score}%`;

      // ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦è‰²ã‚’å¤‰æ›´
      if (data.geo_score >= 70) {
        scoreDisplay.className = "text-5xl font-bold text-green-600";
      } else if (data.geo_score >= 40) {
        scoreDisplay.className = "text-5xl font-bold text-yellow-600";
      } else {
        scoreDisplay.className = "text-5xl font-bold text-red-600";
      }

      // 4è»¸è©³ç´°ã‚¹ã‚³ã‚¢ + ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ¶å¾¡
      const scoresDetail = document.getElementById(
        "scores-detail",
      ) as HTMLDivElement;
      if (data.scores) {
        scoresDetail.classList.remove("hidden");
        const isPremium = data.is_premium || false;

        (
          document.getElementById("score-structure") as HTMLDivElement
        ).textContent = String(data.scores.structure);
        (
          document.getElementById("score-context") as HTMLDivElement
        ).textContent = isPremium ? String(data.scores.context) : "???";
        (
          document.getElementById("score-freshness") as HTMLDivElement
        ).textContent = isPremium ? String(data.scores.freshness) : "???";
        (
          document.getElementById("score-credibility") as HTMLDivElement
        ).textContent = isPremium ? String(data.scores.credibility) : "???";

        // ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºåˆ¶å¾¡ï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
        const maskContext = document.getElementById("mask-context");
        const maskFreshness = document.getElementById("mask-freshness");
        const maskCredibility = document.getElementById("mask-credibility");
        const proUpgradeBanner = document.getElementById("pro-upgrade-banner");

        if (isPremium) {
          // Proãƒ¦ãƒ¼ã‚¶ãƒ¼: å…¨ã¦è¡¨ç¤º
          maskContext?.classList.add("hidden");
          maskFreshness?.classList.add("hidden");
          maskCredibility?.classList.add("hidden");
          proUpgradeBanner?.classList.add("hidden");
        } else {
          // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼: Structureä»¥å¤–ã‚’ãƒã‚¹ã‚¯
          maskContext?.classList.remove("hidden");
          maskFreshness?.classList.remove("hidden");
          maskCredibility?.classList.remove("hidden");
          proUpgradeBanner?.classList.remove("hidden");
        }
      } else {
        scoresDetail.classList.add("hidden");
      }

      // ç·è©•
      const summaryEl = document.getElementById(
        "result-summary",
      ) as HTMLParagraphElement;
      summaryEl.textContent = data.summary;

      // è‰¯ã„ç‚¹
      const strengthsEl = document.getElementById(
        "result-strengths",
      ) as HTMLUListElement;
      const t = (translations as any)[currentLang];

      if (data.strengths.length > 0) {
        strengthsEl.innerHTML = DOMPurify.sanitize(
          data.strengths
            .map(
              (s) =>
                `<li class="flex items-start gap-2"><span class="text-emerald-600">âœ“</span><span>${DOMPurify.sanitize(s)}</span></li>`,
            )
            .join(""),
        );
      } else {
        strengthsEl.innerHTML = `<li class="text-slate-500 italic">${t.no_strengths_found}</li>`;
      }

      // æ°—ã«ãªã‚‹ç‚¹ï¼ˆå¼•ç”¨æ©Ÿä¼šã¸ã®å½±éŸ¿åº¦ä»˜ãï¼‰
      const issuesEl = document.getElementById(
        "result-issues",
      ) as HTMLDivElement;

      let issuesHtml = "";

      if (data.issues.length > 0) {
        issuesHtml = data.issues
          .map((issue, index) => {
            const t = (translations as any)[currentLang];
            // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯1å€‹ç›®ä»¥å¤–ãƒã‚¹ã‚¯è¡¨ç¤º
            const isLocked = !data.is_premium && index >= 1;

            let impactClass = "bg-blue-100 text-blue-800";
            let impactText = t.impact_low;

            if (["High", "å¤§"].includes(issue.impact)) {
              impactClass = "bg-red-100 text-red-800";
              impactText = t.impact_high;
            } else if (["Medium", "ä¸­"].includes(issue.impact)) {
              impactClass = "bg-yellow-100 text-yellow-800";
              impactText = t.impact_medium;
            }

            const suggestionHtml = issue.suggestion
              ? `<div class="mt-3 p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
                   <p class="text-xs font-medium text-emerald-800 mb-1">${t.suggestion_prefix}</p>
                   <p class="text-sm text-emerald-700">${issue.suggestion}</p>
                 </div>`
              : "";

            // ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒã‚¹ã‚¯è¡¨ç¤º
            if (isLocked) {
              return `
                <div class="bg-white rounded-lg p-4 relative overflow-hidden border border-slate-100">
                  <div class="filter blur-md select-none pointer-events-none opacity-50">
                    <div class="flex items-center gap-2 mb-2">
                      <h4 class="font-bold text-slate-800">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</h4>
                      <span class="text-xs px-2 py-0.5 rounded ${impactClass}">${impactText}</span>
                    </div>
                    <p class="text-slate-600 text-sm">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</p>
                  </div>
                  <div class="absolute inset-0 flex flex-col items-center justify-center z-10 cursor-pointer hover:bg-white/10 transition js-pro-lock-overlay">
                       <div class="bg-indigo-600 text-white px-5 py-3 rounded-xl font-bold flex items-center gap-2 shadow-2xl transform hover:scale-105 transition border border-indigo-500">
                          <span>${t.pro_lock}</span>
                       </div>
                  </div>
                </div>
              `;
            }

            return `
              <div class="bg-white rounded-lg p-4 relative overflow-hidden group border border-slate-100 hover:shadow-md transition">
                <div class="transition duration-500">
                  <div class="flex items-center gap-2 mb-2">
                    <h4 class="font-bold text-slate-800">${issue.title}</h4>
                    <span class="text-xs px-2 py-0.5 rounded ${impactClass}">${impactText}</span>
                  </div>
                  <p class="text-slate-600 text-sm">${issue.description}</p>
                  ${suggestionHtml}
                </div>
              </div>
            `;
          })
          .join("");
      } else {
        issuesHtml = `<div class="text-slate-500 italic p-4">${t.no_issues_found}</div>`;
      }

      // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ãƒ€ãƒŸãƒ¼ã®ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸæ”¹å–„æ¡ˆã‚’è¡¨ç¤ºã—ã¦ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’è¨´æ±‚
      if (!data.is_premium) {
        const t = (translations as any)[currentLang];
        // ãƒ€ãƒŸãƒ¼è¦ç´ ã‚’2ã¤è¿½åŠ 
        const dummyLockedHtml = `
          <div class="bg-white rounded-lg p-4 relative overflow-hidden border border-slate-100">
            <div class="filter blur-md select-none pointer-events-none opacity-50">
              <div class="flex items-center gap-2 mb-2">
                <h4 class="font-bold text-slate-800">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</h4>
                <span class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-800">${t.impact_high}</span>
              </div>
              <p class="text-slate-600 text-sm">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</p>
            </div>
            <div class="absolute inset-0 flex flex-col items-center justify-center z-10 cursor-pointer hover:bg-white/10 transition js-pro-lock-overlay">
                 <div class="bg-indigo-600 text-white px-5 py-3 rounded-xl font-bold flex items-center gap-2 shadow-2xl transform hover:scale-105 transition border border-indigo-500">
                    <span>${t.pro_lock}</span>
                 </div>
            </div>
          </div>
          <div class="bg-white rounded-lg p-4 relative overflow-hidden border border-slate-100">
            <div class="filter blur-md select-none pointer-events-none opacity-50">
               <div class="flex items-center gap-2 mb-2">
                <h4 class="font-bold text-slate-800">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</h4>
                <span class="text-xs px-2 py-0.5 rounded bg-yellow-100 text-yellow-800">${t.impact_medium}</span>
              </div>
              <p class="text-slate-600 text-sm">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</p>
            </div>
            <div class="absolute inset-0 flex flex-col items-center justify-center z-10 cursor-pointer hover:bg-white/10 transition js-pro-lock-overlay">
                 <div class="bg-indigo-600 text-white px-5 py-3 rounded-xl font-bold flex items-center gap-2 shadow-2xl transform hover:scale-105 transition border border-indigo-500">
                    <span>${t.pro_lock}</span>
                 </div>
            </div>
          </div>
        `;
        issuesHtml += dummyLockedHtml;
      }

      issuesEl.innerHTML = DOMPurify.sanitize(issuesHtml);

      // AIæ¤œç´¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      const impressionEl = document.getElementById(
        "result-impression",
      ) as HTMLDivElement;
      // ç°¡æ˜“Markdownãƒ‘ãƒ¼ã‚µãƒ¼: **bold** ã‚’ <strong>bold</strong> ã«å¤‰æ›
      // DOMPurifyã§ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå¾Œã«Markdownå¤‰æ›
      const sanitizedImpression = DOMPurify.sanitize(data.impression);
      const formattedImpression = sanitizedImpression
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>") // Bold
        .replace(/\n/g, "<br />"); // Newlines
      impressionEl.innerHTML = DOMPurify.sanitize(formattedImpression);

      // æ®‹ã‚Šã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ•°ã®æ›´æ–°ï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰
      const remainingCredits = document.getElementById(
        "remaining-credits",
      ) as HTMLDivElement;
      const remainingCreditsCount = document.getElementById(
        "remaining-credits-count",
      ) as HTMLSpanElement;
      if (!data.is_premium && data.free_credits !== undefined) {
        remainingCredits.classList.remove("hidden");
        remainingCreditsCount.textContent = String(data.free_credits);
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨ç¤ºã‚‚æ›´æ–°
        creditsInfo.classList.remove("hidden");
        creditsCount.textContent = String(data.free_credits);
      } else {
        remainingCredits.classList.add("hidden");
        creditsInfo.classList.add("hidden");
      }

      result.classList.remove("hidden");
      result.scrollIntoView({ behavior: "smooth" });
    }
  </script>
</Layout>

<style>
  @keyframes float {
    0% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-20px);
    }
    100% {
      transform: translateY(0px);
    }
  }
  @keyframes float-slow {
    0% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-15px);
    }
    100% {
      transform: translateY(0px);
    }
  }
  @keyframes float-medium {
    0% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-10px);
    }
    100% {
      transform: translateY(0px);
    }
  }
  .animate-float {
    animation: float 6s ease-in-out infinite;
  }
  .animate-float-slow {
    animation: float-slow 8s ease-in-out infinite;
  }
  .animate-float-medium {
    animation: float-medium 5s ease-in-out infinite;
  }

  .perspective-1000 {
    perspective: 1000px;
  }

  @keyframes shake {
    0%,
    100% {
      transform: translateX(0);
    }
    10%,
    30%,
    50%,
    70%,
    90% {
      transform: translateX(-4px);
    }
    20%,
    40%,
    60%,
    80% {
      transform: translateX(4px);
    }
  }
  .animate-shake {
    animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-fade-in-up {
    animation: fadeInUp 0.8s ease-out forwards;
  }
</style>
