---
import Layout from "../layouts/Layout.astro";

// Server-side language detection
const headers = Astro.request.headers;

// 1. Check Vercel IP country header (most reliable for deployed env)
const ipCountry = headers.get("x-vercel-ip-country");

// 2. Check Accept-Language header as fallback
const acceptLanguage = headers.get("accept-language") || "";
const prefersJapanese = acceptLanguage.toLowerCase().startsWith("ja");

// Determine initial language: Japanese only for Japan IP, otherwise English
let initialLang: "ja" | "en" = "en";
if (ipCountry === "JP") {
  initialLang = "ja";
} else if (!ipCountry && prefersJapanese) {
  // Local dev or no IP header: use browser preference
  initialLang = "ja";
}
---

<Layout title="GEOè¨ºæ–­ - AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³æœ€é©åŒ–ãƒã‚§ãƒƒã‚«ãƒ¼">
  <main class="container mx-auto px-4 py-12 max-w-4xl">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header
      class="text-center mb-12 relative flex flex-col items-center md:block"
    >
      <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
      <div
        class="w-full flex justify-end items-center gap-4 z-50 mb-4 md:absolute md:top-0 md:right-0 md:w-auto md:mb-0"
      >
        <button
          id="header-login-btn"
          class="hidden text-sm font-medium text-indigo-600 bg-white px-4 py-2 rounded-lg shadow-sm border border-indigo-100 hover:shadow-md transition"
          data-i18n="login_suggest"
        >
          ãƒ­ã‚°ã‚¤ãƒ³
        </button>
        <div id="header-user-info" class="hidden items-center gap-3">
          <div class="text-right">
            <p id="user-email" class="text-xs text-slate-500"></p>
            <span
              id="credit-badge"
              class="inline-block text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full"
              >æ®‹ã‚Š: -å›</span
            >
          </div>
          <button
            id="header-logout-btn"
            class="text-xs text-slate-400 hover:text-red-500 underline transition"
            data-i18n="logout"
          >
            ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
          </button>
        </div>
      </div>

      <!-- è¨€èªåˆ‡ã‚Šæ›¿ãˆ -->
      <div class="flex justify-center mb-6 md:mt-0">
        <div class="bg-slate-100 p-1 rounded-lg inline-flex shadow-inner">
          <button
            id="lang-btn-ja"
            class="px-4 py-1.5 rounded-md text-sm font-bold bg-white text-indigo-600 shadow-sm transition-all pointer-events-auto z-10"
            >æ—¥æœ¬èª</button
          >
          <button
            id="lang-btn-en"
            class="px-4 py-1.5 rounded-md text-sm font-medium text-slate-500 hover:text-indigo-600 transition-all pointer-events-auto z-10"
            >English</button
          >
        </div>
      </div>

      <h1
        data-i18n="title"
        class="text-4xl md:text-5xl font-bold text-slate-900 mb-4"
      >
        GEOè¨ºæ–­
      </h1>
      <p
        data-i18n="description"
        class="text-xl text-slate-600 max-w-2xl mx-auto"
      >
        AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«<span class="text-indigo-600 font-semibold"
          >ã€Œå¼•ç”¨ã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€</span
        >ã‹ã©ã†ã‹ã‚’è¨ºæ–­ã—ã¾ã™
      </p>
    </header>

    <!-- URLå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <section class="bg-white rounded-2xl shadow-xl p-8 mb-8">
      <form id="diagnosis-form" class="space-y-6">
        <div>
          <label
            for="url-input"
            class="block text-sm font-medium text-slate-700 mb-2"
            data-i18n="label_url"
          >
            è¨ºæ–­ã—ãŸã„URLã‚’å…¥åŠ›
          </label>
          <input
            type="url"
            id="url-input"
            name="url"
            placeholder="https://example.com"
            required
            class="w-full px-4 py-3 text-lg border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
          />
        </div>
        <button
          type="submit"
          id="submit-btn"
          class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl text-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
          data-i18n="btn_diagnose"
        >
          GEOè¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹
        </button>
      </form>

      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
      <div id="loading" class="hidden mt-6 text-center">
        <div
          class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-indigo-600 border-t-transparent"
        >
        </div>
        <p class="mt-3 text-slate-600 font-medium" data-i18n="loading_msg">
          AIæ¤œç´¢å¯¾ç­–ã‚’ç²¾å¯†è¨ºæ–­ä¸­...ï¼ˆ1ã€œ2åˆ†ç¨‹åº¦ï¼‰
        </p>
        <div class="mt-4 text-xs text-slate-400 space-y-1">
          <p id="loading-step-1" data-i18n="loading_step1">
            ğŸ–¥ï¸ ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ä¸­...
          </p>
          <p id="loading-step-2" class="opacity-50" data-i18n="loading_step2">
            ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã—ã¦è¦–è¦šåˆ†æä¸­...
          </p>
          <p id="loading-step-3" class="opacity-50" data-i18n="loading_step3">
            ğŸ¤– AIã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§è©•ä¾¡ä¸­...
          </p>
        </div>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
      <div
        id="error"
        class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700"
      >
      </div>
    </section>

    <!-- è¨ºæ–­çµæœ -->
    <section id="result" class="hidden space-y-6">
      <!-- GEOã‚¹ã‚³ã‚¢ -->
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <h2
          class="text-2xl font-bold text-slate-900 mb-4"
          data-i18n="geo_score"
        >
          GEOã‚¹ã‚³ã‚¢
        </h2>
        <div class="flex items-center gap-4">
          <div id="score-display" class="text-5xl font-bold text-indigo-600">
            --
          </div>
          <div class="flex-1">
            <div class="h-4 bg-slate-200 rounded-full overflow-hidden">
              <div
                id="score-bar"
                class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 transition-all duration-500"
                style="width: 0%"
              >
              </div>
            </div>
            <p class="text-sm text-slate-500 mt-1" data-i18n="geo_score_desc">
              AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«å¼•ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§
            </p>
          </div>
        </div>
        <!-- æ³¨æ„æ›¸ã -->
        <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
          <p class="text-sm text-amber-800 flex items-start gap-2">
            <span class="flex-shrink-0">âš ï¸</span>
            <span>
              <strong data-i18n="score_warning_title"
                >ã“ã®ã‚¹ã‚³ã‚¢ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ§‹é€ ã®æœ€é©åº¦ã‚’æ¸¬å®šã—ã¦ã„ã¾ã™ã€‚</strong
              ><br />
              <span data-i18n="score_warning_desc">
                ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¨©å¨æ€§ãƒ»è¢«ãƒªãƒ³ã‚¯ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰èªçŸ¥åº¦ã¯è€ƒæ…®ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å¤§æ‰‹ã‚µã‚¤ãƒˆï¼ˆRedditã€Wikipediaç­‰ï¼‰ã¯æ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¦ã„ãªãã¦ã‚‚AIã«å¼•ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
              </span>
            </span>
          </p>
        </div>
      </div>

      <!-- 4è»¸è©³ç´°ã‚¹ã‚³ã‚¢ï¼ˆãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¯¾å¿œï¼‰ -->
      <div id="scores-detail" class="bg-white rounded-2xl shadow-xl p-8 hidden">
        <h2
          class="text-2xl font-bold text-slate-900 mb-4"
          data-i18n="axes_title"
        >
          4ã¤ã®è©•ä¾¡è»¸
        </h2>
        <div class="grid md:grid-cols-4 gap-4">
          <!-- Structureï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
          <div class="text-center p-4 bg-blue-50 rounded-xl">
            <div id="score-structure" class="text-3xl font-bold text-blue-600">
              --
            </div>
            <p class="text-xs text-slate-600 mt-1">Structure</p>
            <p class="text-xs text-slate-400" data-i18n="desc_structure">
              æ§‹é€ ãƒ»æ©Ÿæ¢°å¯èª­æ€§
            </p>
          </div>
          <!-- Contextï¼ˆç„¡æ–™ã¯ãƒã‚¹ã‚¯ï¼‰ -->
          <div
            id="axis-context"
            class="text-center p-4 bg-purple-50 rounded-xl relative"
          >
            <div id="score-context" class="text-3xl font-bold text-purple-600">
              --
            </div>
            <p class="text-xs text-slate-600 mt-1">Context</p>
            <p class="text-xs text-slate-400" data-i18n="desc_context">
              æ–‡è„ˆãƒ»æ„å‘³ç†è§£
            </p>
            <!-- ãƒã‚¹ã‚¯ -->
            <div
              id="mask-context"
              class="absolute inset-0 bg-slate-800/90 rounded-xl flex flex-col items-center justify-center hidden"
            >
              <span class="text-2xl mb-1">ğŸ”’</span>
              <span class="text-white font-bold text-lg" data-i18n="metric_b"
                >æŒ‡æ¨™B</span
              >
            </div>
          </div>
          <!-- Freshnessï¼ˆç„¡æ–™ã¯ãƒã‚¹ã‚¯ï¼‰ -->
          <div
            id="axis-freshness"
            class="text-center p-4 bg-green-50 rounded-xl relative"
          >
            <div id="score-freshness" class="text-3xl font-bold text-green-600">
              --
            </div>
            <p class="text-xs text-slate-600 mt-1">Freshness</p>
            <p class="text-xs text-slate-400" data-i18n="desc_freshness">
              æƒ…å ±ã®é®®åº¦
            </p>
            <!-- ãƒã‚¹ã‚¯ -->
            <div
              id="mask-freshness"
              class="absolute inset-0 bg-slate-800/90 rounded-xl flex flex-col items-center justify-center hidden"
            >
              <span class="text-2xl mb-1">ğŸ”’</span>
              <span class="text-white font-bold text-lg" data-i18n="metric_c"
                >æŒ‡æ¨™C</span
              >
            </div>
          </div>
          <!-- Credibilityï¼ˆç„¡æ–™ã¯ãƒã‚¹ã‚¯ï¼‰ -->
          <div
            id="axis-credibility"
            class="text-center p-4 bg-orange-50 rounded-xl relative"
          >
            <div
              id="score-credibility"
              class="text-3xl font-bold text-orange-600"
            >
              --
            </div>
            <p class="text-xs text-slate-600 mt-1">Credibility</p>
            <p class="text-xs text-slate-400" data-i18n="desc_credibility">
              ä¿¡é ¼æ€§ã‚·ã‚°ãƒŠãƒ«
            </p>
            <!-- ãƒã‚¹ã‚¯ -->
            <div
              id="mask-credibility"
              class="absolute inset-0 bg-slate-800/90 rounded-xl flex flex-col items-center justify-center hidden"
            >
              <span class="text-2xl mb-1">ğŸ”’</span>
              <span class="text-white font-bold text-lg" data-i18n="metric_d"
                >æŒ‡æ¨™D</span
              >
            </div>
          </div>
        </div>
        <!-- Proèª˜å°ãƒãƒŠãƒ¼ï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤ºï¼‰ -->
        <div <!-- Proèª˜å°ãƒãƒŠãƒ¼ï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤ºï¼‰ -->
          <div
            id="pro-upgrade-banner"
            class="hidden mt-8 p-1 rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 shadow-xl relative overflow-hidden group"
          >
            <!-- èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
            <div
              class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition duration-700"
            >
            </div>
            <div
              class="absolute -top-24 -right-24 w-64 h-64 bg-yellow-300/30 rounded-full blur-3xl pointer-events-none"
            >
            </div>

            <div
              class="bg-slate-900 rounded-xl p-6 relative h-full flex flex-col"
            >
              <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
              <div class="mb-6">
                <h3
                  class="text-2xl font-bold text-white mb-2 flex items-center gap-2"
                >
                  <span data-i18n="pro_card_title">Proãƒ—ãƒ©ãƒ³ã§åˆ¶é™ã‚’è§£é™¤</span>
                </h3>
                <p
                  class="text-indigo-200 text-sm"
                  data-i18n="pro_card_subtitle"
                >
                  AIæ¤œç´¢æœ€é©åŒ–ã‚’åŠ é€Ÿã•ã›ã¾ã—ã‚‡ã†
                </p>
              </div>

              <!-- ãƒ¡ãƒªãƒƒãƒˆãƒªã‚¹ãƒˆ -->
              <ul class="space-y-4 mb-8 flex-1">
                <li class="flex items-start gap-3">
                  <div
                    class="flex-shrink-0 bg-indigo-500/20 p-1 rounded-full text-indigo-300 mt-0.5"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="3"
                        d="M5 13l4 4L19 7"></path></svg
                    >
                  </div>
                  <div>
                    <span
                      class="font-bold text-white block text-lg"
                      data-i18n="benefit_unlimited_title">å›æ•°ç„¡åˆ¶é™</span
                    >
                    <span
                      class="text-slate-400 text-xs"
                      data-i18n="benefit_unlimited_desc"
                      >å¿ƒã‚†ãã¾ã§ä½•åº¦ã§ã‚‚è¨ºæ–­ãƒ»æ”¹å–„ã‚’è©¦ã›ã¾ã™</span
                    >
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <div
                    class="flex-shrink-0 bg-indigo-500/20 p-1 rounded-full text-indigo-300 mt-0.5"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="3"
                        d="M5 13l4 4L19 7"></path></svg
                    >
                  </div>
                  <div>
                    <span
                      class="font-bold text-white block text-lg"
                      data-i18n="benefit_accuracy_title">ç²¾åº¦å‘ä¸Š</span
                    >
                    <span
                      class="text-slate-400 text-xs"
                      data-i18n="benefit_accuracy_desc"
                      >ã‚ˆã‚Šè©³ç´°ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§æ·±ã„åˆ†æãŒå¯èƒ½ã«</span
                    >
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <div
                    class="flex-shrink-0 bg-indigo-500/20 p-1 rounded-full text-indigo-300 mt-0.5"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="3"
                        d="M5 13l4 4L19 7"></path></svg
                    >
                  </div>
                  <div>
                    <span
                      class="font-bold text-white block text-lg"
                      data-i18n="benefit_advice_title"
                      >å…¨ã¦ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç¢ºèª</span
                    >
                    <span
                      class="text-slate-400 text-xs"
                      data-i18n="benefit_advice_desc"
                      >è§£æ±ºç­–ã‚’å«ã‚€è©³ç´°ãªæ”¹å–„æŒ‡ç¤ºã‚’å®Œå…¨è¡¨ç¤º</span
                    >
                  </div>
                </li>
              </ul>

              <!-- ãƒœã‚¿ãƒ³ -->
              <button
                id="upgrade-btn"
                class="js-pro-upgrade-btn w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-indigo-500/30 transition transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2 group-hover:shadow-indigo-500/50"
              >
                <span data-i18n="btn_pro_plan"
                  >Proãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹ï¼ˆæœˆé¡1,980å††ï¼‰</span
                >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg
                >
              </button>
              <p
                class="text-center text-xs text-slate-500 mt-3"
                data-i18n="cancel_anytime"
              >
                ã„ã¤ã§ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½
              </p>
            </div>
          </div>
        </div>

        <!-- ç·è©• -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <h2
            class="text-2xl font-bold text-slate-900 mb-4"
            data-i18n="summary_title"
          >
            ç·è©•
          </h2>
          <p id="result-summary" class="text-lg text-slate-700 leading-relaxed">
          </p>
        </div>

        <div class="bg-emerald-50 rounded-2xl shadow-xl p-8">
          <h2
            class="text-2xl font-bold text-emerald-800 mb-4"
            data-i18n="strengths_title"
          >
            AIã«è©•ä¾¡ã•ã‚Œã‚‹ãƒã‚¤ãƒ³ãƒˆ
          </h2>
          <ul id="result-strengths" class="space-y-2"></ul>
        </div>

        <!-- æ°—ã«ãªã‚‹ç‚¹ -->
        <div class="bg-amber-50 rounded-2xl shadow-xl p-8">
          <h2
            class="text-2xl font-bold text-amber-800 mb-4"
            data-i18n="issues_title"
          >
            å¼•ç”¨æ©Ÿä¼šã‚’æãªã†ãƒã‚¤ãƒ³ãƒˆ
          </h2>
          <div id="result-issues" class="space-y-4"></div>
        </div>

        <!-- AIæ¤œç´¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆChatGPTé¢¨UIï¼‰ -->
        <div class="bg-slate-900 rounded-2xl shadow-xl p-8">
          <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.896zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08-4.778 2.758a.795.795 0 0 0-.393.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.597 1.5-2.607-1.5z"
              ></path>
            </svg>
            <span data-i18n="preview_title">AIæ¤œç´¢ã§ã®è¡¨ç¤ºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
          </h2>
          <div class="flex gap-3">
            <div
              class="w-8 h-8 rounded-full bg-teal-500 flex items-center justify-center flex-shrink-0"
            >
              <svg
                class="w-5 h-5 text-white"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494z"
                ></path>
              </svg>
            </div>
            <div
              id="result-impression"
              class="bg-slate-800 rounded-2xl rounded-tl-none p-4 text-slate-100 leading-relaxed flex-1"
            >
            </div>
          </div>
        </div>

        <!-- æ®‹ã‚Šã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ•°è¡¨ç¤ºï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰ -->
        <div
          id="remaining-credits"
          class="hidden mb-4 p-3 bg-indigo-50 rounded-xl text-center"
        >
          <p class="text-sm text-indigo-800">
            <span data-i18n="credits_remain_prefix">ä»Šæœˆã®æ®‹ã‚Šè¨ºæ–­å›æ•°:</span>
            <span id="remaining-credits-count" class="font-bold text-indigo-600"
              >3</span
            >
            <span data-i18n="credits_remain_suffix">å›</span>
          </p>
        </div>

        <!-- å†è¨ºæ–­ãƒœã‚¿ãƒ³ -->
        <div class="text-center">
          <button
            id="reset-btn"
            class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium py-3 px-8 rounded-xl transition"
            data-i18n="btn_reset"
          >
            åˆ¥ã®URLã‚’è¨ºæ–­ã™ã‚‹
          </button>
        </div>
      </div>

      <!-- ç‰¹å¾´èª¬æ˜ -->
      <section class="mt-16 grid md:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <div class="text-3xl mb-3">ğŸ‘ï¸</div>
          <h3 class="font-bold text-lg mb-2" data-i18n="feat1_title">
            è¦–è¦šçš„ä¿¡é ¼æ€§ã‚’åˆ†æ
          </h3>
          <p class="text-slate-600 text-sm" data-i18n="feat1_desc">
            Visionï¼ˆç”»åƒèªè­˜ï¼‰æ©Ÿèƒ½ã§ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã‚„å›³è§£ã®ã‚ã‹ã‚Šã‚„ã™ã•ã‚‚è©•ä¾¡ã€‚
          </p>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <div class="text-3xl mb-3">ğŸ–¥ï¸</div>
          <h3 class="font-bold text-lg mb-2" data-i18n="feat2_title">
            å‹•çš„ã‚µã‚¤ãƒˆå®Œå…¨å¯¾å¿œ
          </h3>
          <p class="text-slate-600 text-sm" data-i18n="feat2_desc">
            JSã§æç”»ã•ã‚Œã‚‹SPAã‚µã‚¤ãƒˆã‚‚ã€å®Ÿéš›ã®è¡¨ç¤ºé€šã‚Šã«æ­£ç¢ºã«è¨ºæ–­ã€‚
          </p>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <div class="text-3xl mb-3">ğŸ’¡</div>
          <h3 class="font-bold text-lg mb-2" data-i18n="feat3_title">
            å…·ä½“çš„ãªæ”¹å–„æŒ‡ç¤º
          </h3>
          <p class="text-slate-600 text-sm" data-i18n="feat3_desc">
            ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒ»ãƒ©ã‚¤ã‚¿ãƒ¼å‘ã‘ã«å³åº§ã«ä¿®æ­£ã§ãã‚‹æŠ€è¡“çš„æŒ‡æ‘˜ã‚’æä¾›ã€‚
          </p>
        </div>
      </section>

      <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
      <footer class="mt-16 text-center text-slate-500 text-sm">
        <p>&copy; 2026 GEOè¨ºæ–­ (Vision Enhanced)</p>
      </footer>
    </section>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div
      id="login-modal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
        <h2
          class="text-2xl font-bold text-slate-900 mb-4"
          data-i18n="modal_title"
        >
          ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™
        </h2>
        <p class="text-slate-600 mb-6" data-i18n="modal_desc">
          è¨ºæ–­çµæœã‚’ä¿å­˜ãƒ»é–²è¦§ã™ã‚‹ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
        </p>
        <button
          id="google-login-btn"
          class="w-full flex items-center justify-center gap-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-medium py-3 px-6 rounded-xl transition"
        >
          <svg class="w-5 h-5" viewBox="0 0 24 24">
            <path
              fill="#4285F4"
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
            ></path>
            <path
              fill="#34A853"
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
            ></path>
            <path
              fill="#FBBC05"
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
            ></path>
            <path
              fill="#EA4335"
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
            ></path>
          </svg>
          <span data-i18n="btn_google_login">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</span>
        </button>
        <button
          id="close-modal-btn"
          class="w-full mt-4 text-slate-500 hover:text-slate-700 text-sm"
          data-i18n="btn_cancel"
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <!-- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ®‹æ•°è¡¨ç¤º -->
        <div
          id="credits-info"
          class="hidden mt-4 p-3 bg-indigo-50 rounded-lg text-center"
        >
          <p class="text-sm text-indigo-800">
            æ®‹ã‚Šè¨ºæ–­å›æ•°: <span id="credits-count" class="font-bold">3</span> å›
          </p>
        </div>
      </div>
    </div>

    <script is:inline define:vars={{ initialLang }}>
      window.__INITIAL_LANG__ = initialLang;
    </script>

    <script>
      import { createClient, SupabaseClient } from "@supabase/supabase-js";

      // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼‰
      const supabaseUrl =
        import.meta.env.PUBLIC_SUPABASE_URL ||
        import.meta.env.SUPABASE_URL ||
        "";
      const supabaseAnonKey =
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY ||
        import.meta.env.SUPABASE_ANON_KEY ||
        "";

      // Supabaseæœªè¨­å®šæ™‚ã¯nullã«ã—ã¦ã‚¹ã‚­ãƒƒãƒ—
      let supabase: SupabaseClient | null = null;
      if (supabaseUrl && supabaseAnonKey) {
        supabase = createClient(supabaseUrl, supabaseAnonKey);
      } else {
        console.error(
          "Supabase API keys are missing. Please check your .env file.",
        );
      }

      // èªè¨¼çŠ¶æ…‹
      let currentUser: any = null;
      let pendingUrl: string | null = null;

      // DOMè¦ç´ 
      const form = document.getElementById("diagnosis-form") as HTMLFormElement;
      const urlInput = document.getElementById("url-input") as HTMLInputElement;
      const submitBtn = document.getElementById(
        "submit-btn",
      ) as HTMLButtonElement;
      const loading = document.getElementById("loading") as HTMLDivElement;
      const error = document.getElementById("error") as HTMLDivElement;
      const result = document.getElementById("result") as HTMLElement;
      const resetBtn = document.getElementById(
        "reset-btn",
      ) as HTMLButtonElement;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
      const loginModal = document.getElementById(
        "login-modal",
      ) as HTMLDivElement;
      const googleLoginBtn = document.getElementById(
        "google-login-btn",
      ) as HTMLButtonElement;
      const closeModalBtn = document.getElementById(
        "close-modal-btn",
      ) as HTMLButtonElement;
      const creditsInfo = document.getElementById(
        "credits-info",
      ) as HTMLDivElement;
      const creditsCount = document.getElementById(
        "credits-count",
      ) as HTMLSpanElement;

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ†ãƒƒãƒ—è¦ç´ 
      const loadingStep1 = document.getElementById(
        "loading-step-1",
      ) as HTMLParagraphElement;
      const loadingStep2 = document.getElementById(
        "loading-step-2",
      ) as HTMLParagraphElement;
      const loadingStep3 = document.getElementById(
        "loading-step-3",
      ) as HTMLParagraphElement;

      // è¨€èªè¨­å®šï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§æ¤œå‡ºã—ãŸåˆæœŸè¨€èªã‚’ä½¿ç”¨ï¼‰
      let currentLang: "ja" | "en" = ((window as any).__INITIAL_LANG__ ||
        "ja") as "ja" | "en";
      const translations = {
        ja: {
          title: "GEOè¨ºæ–­",
          description: `AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«<span class="text-indigo-600 font-semibold">ã€Œå¼•ç”¨ã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€</span>ã‹ã©ã†ã‹ã‚’è¨ºæ–­ã—ã¾ã™`,
          label_url: "è¨ºæ–­ã—ãŸã„URLã‚’å…¥åŠ›",
          btn_diagnose: "GEOè¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹",
          loading_msg: "AIæ¤œç´¢å¯¾ç­–ã‚’ç²¾å¯†è¨ºæ–­ä¸­...ï¼ˆ1ã€œ2åˆ†ç¨‹åº¦ï¼‰",
          loading_step1: "ğŸ–¥ï¸ ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ä¸­...",
          loading_step2: "ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã—ã¦è¦–è¦šåˆ†æä¸­...",
          loading_step3: "ğŸ¤– AIã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§è©•ä¾¡ä¸­...",
          geo_score: "GEOã‚¹ã‚³ã‚¢",
          geo_score_desc: "AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«å¼•ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§",
          suggestion_prefix: "ğŸ’¡ æ”¹å–„ææ¡ˆ:",
          impact_high: "å½±éŸ¿: å¤§",
          impact_medium: "å½±éŸ¿: ä¸­",
          impact_low: "å½±éŸ¿: å°",
          pro_lock: "ğŸ”’ Proãƒ—ãƒ©ãƒ³ã§è©³ç´°ã‚’è¡¨ç¤º",
          score_structure: "Structure (æ§‹é€ )",
          score_context: "Context (æ–‡è„ˆ)",
          score_freshness: "Freshness (é®®åº¦)",
          score_credibility: "Credibility (ä¿¡é ¼æ€§)",

          desc_structure: "æ§‹é€ ãƒ»æ©Ÿæ¢°å¯èª­æ€§",
          desc_context: "æ–‡è„ˆãƒ»æ„å‘³ç†è§£",
          desc_freshness: "æƒ…å ±ã®é®®åº¦",
          desc_credibility: "ä¿¡é ¼æ€§ã‚·ã‚°ãƒŠãƒ«",
          metric_b: "æŒ‡æ¨™B",
          metric_c: "æŒ‡æ¨™C",
          metric_d: "æŒ‡æ¨™D",
          pro_banner_title: "ğŸ”’ AIã«è¦‹è½ã¨ã•ã‚Œã‚‹è‡´å‘½çš„ãªåŸå› ãŒã‚ã‚Šã¾ã™",
          pro_banner_desc:
            "Proãƒ—ãƒ©ãƒ³ã§3ã¤ã®è¬ã®æŒ‡æ¨™ã‚’è§£é™¤ã—ã€ã™ã¹ã¦ã®æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚",
          btn_pro_plan: "Proãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹ï¼ˆæœˆé¡1,980å††ï¼‰",
          no_strengths_found: "ç‰¹ã«è©•ä¾¡ã•ã‚Œã‚‹ãƒã‚¤ãƒ³ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚",
          no_issues_found: "ç‰¹ã«æ”¹å–„ã™ã¹ããƒã‚¤ãƒ³ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚",
          login_suggest: "ãƒ­ã‚°ã‚¤ãƒ³",
          feat1_title: "è¦–è¦šçš„ä¿¡é ¼æ€§ã‚’åˆ†æ",
          feat1_desc:
            "Visionï¼ˆç”»åƒèªè­˜ï¼‰æ©Ÿèƒ½ã§ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã‚„å›³è§£ã®ã‚ã‹ã‚Šã‚„ã™ã•ã‚‚è©•ä¾¡ã€‚",
          feat2_title: "å‹•çš„ã‚µã‚¤ãƒˆå®Œå…¨å¯¾å¿œ",
          feat2_desc: "JSã§æç”»ã•ã‚Œã‚‹SPAã‚µã‚¤ãƒˆã‚‚ã€å®Ÿéš›ã®è¡¨ç¤ºé€šã‚Šã«æ­£ç¢ºã«è¨ºæ–­ã€‚",
          feat3_title: "å…·ä½“çš„ãªæ”¹å–„æŒ‡ç¤º",
          feat3_desc:
            "ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒ»ãƒ©ã‚¤ã‚¿ãƒ¼å‘ã‘ã«å³åº§ã«ä¿®æ­£ã§ãã‚‹æŠ€è¡“çš„æŒ‡æ‘˜ã‚’æä¾›ã€‚",
          credits_remain_prefix: "ä»Šæœˆã®æ®‹ã‚Šè¨ºæ–­å›æ•°: ",
          credits_remain_suffix: "å›",
          btn_reset: "åˆ¥ã®URLã‚’è¨ºæ–­ã™ã‚‹",
          modal_title: "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™",
          modal_desc:
            "è¨ºæ–­çµæœã‚’ä¿å­˜ãƒ»é–²è¦§ã™ã‚‹ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚",
          btn_google_login: "Googleã§ãƒ­ã‚°ã‚¤ãƒ³",
          btn_cancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
          logout: "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ",
          score_warning_title:
            "ã“ã®ã‚¹ã‚³ã‚¢ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ§‹é€ ã®æœ€é©åº¦ã‚’æ¸¬å®šã—ã¦ã„ã¾ã™ã€‚",
          score_warning_desc:
            "ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¨©å¨æ€§ãƒ»è¢«ãƒªãƒ³ã‚¯ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰èªçŸ¥åº¦ã¯è€ƒæ…®ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å¤§æ‰‹ã‚µã‚¤ãƒˆï¼ˆRedditã€Wikipediaç­‰ï¼‰ã¯æ§‹é€ ãŒæœ€é©åŒ–ã•ã‚Œã¦ã„ãªãã¦ã‚‚AIã«å¼•ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚",
          axes_title: "4ã¤ã®è©•ä¾¡è»¸",
          summary_title: "ç·è©•",
          strengths_title: "AIã«è©•ä¾¡ã•ã‚Œã‚‹ãƒã‚¤ãƒ³ãƒˆ",
          issues_title: "å¼•ç”¨æ©Ÿä¼šã‚’æãªã†ãƒã‚¤ãƒ³ãƒˆ",
          preview_title: "AIæ¤œç´¢ã§ã®è¡¨ç¤ºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼",
          credits_exhausted_msg:
            "ä»Šæœˆã®ç„¡æ–™è¨ºæ–­å›æ•°ï¼ˆ3å›ï¼‰ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸã€‚Proãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹ã¨ç„¡åˆ¶é™ã«è¨ºæ–­ã§ãã¾ã™ã€‚",
          btn_upgrade_error: "Proãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰",
          pro_card_title: "Proãƒ—ãƒ©ãƒ³ã§åˆ¶é™ã‚’è§£é™¤",
          pro_card_subtitle: "AIæ¤œç´¢æœ€é©åŒ–ã‚’åŠ é€Ÿã•ã›ã‚‹å¼·åŠ›ãªæ©Ÿèƒ½",
          benefit_unlimited_title: "å›æ•°ç„¡åˆ¶é™",
          benefit_unlimited_desc: "å¿ƒã‚†ãã¾ã§ä½•åº¦ã§ã‚‚è¨ºæ–­ãƒ»æ”¹å–„ã‚’è©¦ã›ã¾ã™",
          benefit_accuracy_title: "ç²¾åº¦å‘ä¸Š",
          benefit_accuracy_desc: "ã‚ˆã‚Šè©³ç´°ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§æ·±ã„åˆ†æãŒå¯èƒ½ã«",
          benefit_advice_title: "å…¨ã¦ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç¢ºèª",
          benefit_advice_desc: "è§£æ±ºç­–ã‚’å«ã‚€è©³ç´°ãªæ”¹å–„æŒ‡ç¤ºã‚’å®Œå…¨è¡¨ç¤º",
          cancel_anytime: "ã„ã¤ã§ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½",
        },
        en: {
          title: "GEO Diagnosis",
          description: `Check if your content is cited by <span class="text-indigo-600 font-semibold">AI Search Engines</span>`,
          label_url: "Enter URL to analyze",
          btn_diagnose: "Start Diagnosis",
          loading_msg:
            "Analyzing for AI Search Optimization... (approx. 1-2 mins)",
          loading_step1: "ğŸ–¥ï¸ Fetching content with headless browser...",
          loading_step2: "ğŸ“¸ Analyzing visual elements (screenshots)...",
          loading_step3: "ğŸ¤– Evaluating with AI algorithms...",
          geo_score: "GEO Score",
          geo_score_desc: "Probability of being cited by AI Search Engines",
          suggestion_prefix: "ğŸ’¡ Suggestion:",
          impact_high: "Impact: High",
          impact_medium: "Impact: Medium",
          impact_low: "Impact: Low",
          pro_lock: "ğŸ”’ Unlock with Pro",
          score_structure: "Structure",
          score_context: "Context",
          score_freshness: "Freshness",
          score_credibility: "Credibility",

          desc_structure: "Schema & Machine Readability",
          desc_context: "Context & Semantic Understanding",
          desc_freshness: "Freshness & Updates",
          desc_credibility: "Credibility Signals",
          metric_b: "Metric B",
          metric_c: "Metric C",
          metric_d: "Metric D",
          pro_banner_title: "ğŸ”’ Critical issues detected",
          pro_banner_desc:
            "Unlock all 4 metrics and full improvement advice with Pro Plan.",
          btn_pro_plan: "Get Pro Plan ($14.99/mo)",
          no_strengths_found: "No specific strengths found.",
          no_issues_found: "No specific issues found.",
          login_suggest: "Login",
          feat1_title: "Visual Reliability Analysis",
          feat1_desc:
            "Evaluate design clarity using Vision (image recognition) capabilities.",
          feat2_title: "Full Dynamic Site Support",
          feat2_desc:
            "Accurately diagnose JS-rendered SPA sites exactly as they appear.",
          feat3_title: "Specific Actionable Advice",
          feat3_desc:
            "Provide technical feedback that engineers and writers can fix immediately.",
          credits_remain_prefix: "Monthly Credits Remaining: ",
          credits_remain_suffix: " times",
          btn_reset: "Analyze Another URL",
          modal_title: "Login Required",
          modal_desc:
            "Please log in with your Google account to save and view diagnostic results.",
          btn_google_login: "Sign in with Google",
          btn_cancel: "Cancel",
          logout: "Log out",
          score_warning_title:
            "This score measures content structure optimization.",
          score_warning_desc:
            "Domain authority, backlinks, and brand recognition are NOT considered. Major sites (Reddit, Wikipedia, etc.) may be cited by AI even without optimized structure.",
          axes_title: "4 Evaluation Axes",
          summary_title: "Overall Summary",
          strengths_title: "Points Evaluated by AI",
          issues_title: "Points Losing Citation Opportunities",
          preview_title: "AI Search Preview",
          credits_exhausted_msg:
            "You have used up your monthly free credits (3). Upgrade to Pro for unlimited diagnosis.",
          btn_upgrade_error: "Upgrade to Pro Plan",
          pro_card_title: "Unlock Pro Features",
          pro_card_subtitle:
            "Powerful features to accelerate AI Search Optimization",
          benefit_unlimited_title: "Unlimited Diagnosis",
          benefit_unlimited_desc:
            "Analyze and improve as many times as you want",
          benefit_accuracy_title: "Improved Accuracy",
          benefit_accuracy_desc: "Deeper analysis with detailed algorithms",
          benefit_advice_title: "View All Advice",
          benefit_advice_desc:
            "Full access to detailed improvement instructions",
          cancel_anytime: "Cancel anytime",
        },
      };

      function setLanguage(lang: "ja" | "en") {
        currentLang = lang;

        // ãƒœã‚¿ãƒ³UIæ›´æ–°
        const btnJa = document.getElementById("lang-btn-ja");
        const btnEn = document.getElementById("lang-btn-en");
        const activeClass =
          "px-4 py-1.5 rounded-md text-sm font-bold bg-white text-indigo-600 shadow-sm transition-all pointer-events-auto z-10";
        const inactiveClass =
          "px-4 py-1.5 rounded-md text-sm font-medium text-slate-500 hover:text-indigo-600 transition-all pointer-events-auto z-10";

        if (btnJa && btnEn) {
          if (lang === "ja") {
            btnJa.className = activeClass;
            btnEn.className = inactiveClass;
          } else {
            btnJa.className = inactiveClass;
            btnEn.className = activeClass;
          }
        }

        // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
        const t = translations[lang] as any;
        const elements = document.querySelectorAll("[data-i18n]");
        elements.forEach((el) => {
          const key = el.getAttribute("data-i18n");
          if (key && t[key]) {
            if (key === "description") {
              el.innerHTML = t[key];
            } else {
              el.textContent = t[key];
            }
          }
        });

        // ãƒãƒƒã‚¸è¡¨ç¤ºæ›´æ–°
        if (typeof updateBadgeUI === "function") {
          updateBadgeUI();
        }
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´ 
      const headerLoginBtn = document.getElementById("header-login-btn");
      const headerUserInfo = document.getElementById("header-user-info");
      const headerLogoutBtn = document.getElementById("header-logout-btn");
      const userEmailEl = document.getElementById("user-email");
      const creditBadge = document.getElementById("credit-badge");

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
      let userProfile: any = null;

      // ãƒãƒƒã‚¸UIæ›´æ–°
      function updateBadgeUI() {
        if (!creditBadge) return;

        if (userProfile) {
          if (userProfile.is_premium) {
            creditBadge.textContent =
              currentLang === "en" ? "Pro Plan" : "Proãƒ—ãƒ©ãƒ³ (ç„¡åˆ¶é™)";
            creditBadge.className =
              "inline-block text-[10px] bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-2 py-0.5 rounded-full";
          } else {
            const prefix = currentLang === "en" ? "Credits: " : "æ®‹ã‚Š: ";
            const suffix = currentLang === "en" ? "" : "å›";
            creditBadge.textContent = `${prefix}${userProfile.free_credits}${suffix}`;
            creditBadge.className =
              "inline-block text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full";
          }
        } else {
          // æœªãƒ­ãƒ¼ãƒ‰æ™‚ã¾ãŸã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚
          creditBadge.textContent =
            currentLang === "en" ? "Credits: -" : "æ®‹ã‚Š: -å›";
        }
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
      async function fetchUserProfile() {
        if (!supabase || !currentUser) return;

        try {
          const {
            data: { session },
          } = await supabase.auth.getSession();
          if (!session?.access_token) return;

          const response = await fetch("/api/me", {
            headers: {
              Authorization: `Bearer ${session.access_token}`,
            },
          });

          if (response.ok) {
            userProfile = await response.json();
            updateBadgeUI();
          }
        } catch (e) {
          console.error("Failed to fetch profile", e);
        }
      }

      // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
      async function checkAuth() {
        if (!supabase) return null;
        const {
          data: { session },
        } = await supabase.auth.getSession();
        currentUser = session?.user ?? null;
        updateHeaderUI();
        if (currentUser) {
          console.log("Logged in as:", currentUser.email);
          fetchUserProfile();
        }
        return currentUser;
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼UIæ›´æ–°
      function updateHeaderUI() {
        if (currentUser) {
          headerLoginBtn?.classList.add("hidden");
          headerUserInfo?.classList.remove("hidden");
          headerUserInfo?.classList.add("flex");
          if (userEmailEl) userEmailEl.textContent = currentUser.email || "";
          // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ fetchUserProfile ã§éåŒæœŸã«æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯åˆæœŸå€¤ã®ã¾ã¾ã«ã—ãªã„
          // ãŸã ã—ã€ã¡ã‚‰ã¤ãé˜²æ­¢ã®ãŸã‚ã«ä½•ã‚‚ã—ãªã„ã‹ã€èª­ã¿è¾¼ã¿ä¸­ã‚’è¡¨ç¤ºã™ã‚‹
        } else {
          headerLoginBtn?.classList.remove("hidden");
          headerUserInfo?.classList.add("hidden");
          headerUserInfo?.classList.remove("flex");
          if (creditBadge) creditBadge.textContent = "æ®‹ã‚Š: -å›";
        }
      }

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      async function logout() {
        if (!supabase) return;
        await supabase.auth.signOut();
        currentUser = null;
        updateHeaderUI();
        window.location.reload();
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º/éè¡¨ç¤º
      function showLoginModal() {
        loginModal.classList.remove("hidden");
        loginModal.classList.add("flex");
      }

      function hideLoginModal() {
        loginModal.classList.add("hidden");
        loginModal.classList.remove("flex");
      }

      // Googleãƒ­ã‚°ã‚¤ãƒ³
      async function loginWithGoogle() {
        if (!supabase) return;
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "google",
          options: {
            redirectTo: window.location.href,
          },
        });
        if (error) {
          console.error("Login error:", error);
        }
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      googleLoginBtn?.addEventListener("click", loginWithGoogle);
      closeModalBtn?.addEventListener("click", hideLoginModal);
      loginModal?.addEventListener("click", (e) => {
        if (e.target === loginModal) hideLoginModal();
      });
      headerLoginBtn?.addEventListener("click", showLoginModal);
      headerLogoutBtn?.addEventListener("click", logout);
      document
        .getElementById("lang-btn-ja")
        ?.addEventListener("click", () => setLanguage("ja"));
      document
        .getElementById("lang-btn-en")
        ?.addEventListener("click", () => setLanguage("en"));

      // èªè¨¼çŠ¶æ…‹å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼
      if (supabase) {
        supabase.auth.onAuthStateChange(async (event, session) => {
          currentUser = session?.user ?? null;
          updateHeaderUI();
          if (currentUser) fetchUserProfile();

          if (event === "SIGNED_IN" && session?.user) {
            hideLoginModal();
            // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ä¿ç•™ä¸­ã®URLãŒã‚ã‚Œã°è‡ªå‹•è¨ºæ–­
            if (pendingUrl) {
              const url = pendingUrl;
              pendingUrl = null;
              urlInput.value = url;
              form.dispatchEvent(new Event("submit"));
            }
          }
        });
      }

      // åˆæœŸåŒ–
      checkAuth();
      // åˆæœŸè¨€èªè¨­å®šã‚’UIã«åæ˜ 
      setLanguage(currentLang);

      // Proãƒ—ãƒ©ãƒ³ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      async function handleUpgradeClick(btnElement?: HTMLButtonElement) {
        // ç‰¹å®šã®ãƒœã‚¿ãƒ³ãŒæ¸¡ã•ã‚Œãªã‹ã£ãŸå ´åˆã¯ #upgrade-btn ã‚’æ¢ã™ (å¾Œæ–¹äº’æ›)
        const upgradeBtn =
          btnElement ||
          (document.getElementById("upgrade-btn") as HTMLButtonElement | null);
        const originalText = upgradeBtn?.innerHTML;

        if (upgradeBtn) {
          upgradeBtn.disabled = true;
          upgradeBtn.innerHTML =
            currentLang === "en"
              ? '<span class="inline-block animate-spin mr-2">â†»</span>Processing...'
              : '<span class="inline-block animate-spin mr-2">â†»</span>å‡¦ç†ä¸­...';
        }

        try {
          const response = await fetch("/api/checkout", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userId: currentUser?.id,
              language: currentLang,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Failed to initiate checkout");
          }

          if (data.url) {
            window.location.href = data.url;
          }
        } catch (err) {
          console.error("Checkout error:", err);
          alert(
            currentLang === "en"
              ? "An error occurred. Please try again."
              : "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
          );
          // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          if (upgradeBtn) {
            upgradeBtn.disabled = false;
            if (originalText) upgradeBtn.innerHTML = originalText;
          }
        }
      }

      // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ™‚ãªã©ã«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      window.addEventListener("pageshow", (event) => {
        // BFCacheã‹ã‚‰å¾©å¸°ã—ãŸå ´åˆã¯èªè¨¼çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
        if (event.persisted) {
          checkAuth();
        }
        // ãƒ˜ãƒƒãƒ€ãƒ¼UIçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        updateHeaderUI();

        const upgradeBtn = document.getElementById(
          "upgrade-btn",
        ) as HTMLButtonElement | null;
        if (upgradeBtn) {
          upgradeBtn.disabled = false;
          // è¨€èªè¨­å®šã‚’å†é©ç”¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’å…ƒã«æˆ»ã™
          setLanguage(currentLang as "ja" | "en");
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºå†…ã®ãƒœã‚¿ãƒ³ã‚‚ãƒªã‚»ãƒƒãƒˆ
        const errorUpgradeBtn = document.getElementById(
          "upgrade-from-error",
        ) as HTMLButtonElement | null;
        if (errorUpgradeBtn) {
          errorUpgradeBtn.disabled = false;
          errorUpgradeBtn.disabled = false;
          errorUpgradeBtn.innerHTML = (translations as any)[
            currentLang
          ].btn_upgrade_error;
        }
      });

      // æ—¢å­˜ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã«ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š (ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã«å¤‰æ›´)
      document.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        // IDã¾ãŸã¯ã‚¯ãƒ©ã‚¹ã§åˆ¤å®š
        const upgradeBtn =
          target.closest("#upgrade-btn") ||
          target.closest(".js-pro-upgrade-btn");
        if (upgradeBtn) {
          handleUpgradeClick(upgradeBtn as HTMLButtonElement);
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const url = urlInput.value.trim();
        if (!url) return;

        // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆSupabaseæœªè¨­å®šæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        if (supabaseUrl && supabaseAnonKey && !currentUser) {
          pendingUrl = url;
          showLoginModal();
          return;
        }

        // UIæ›´æ–°
        submitBtn.disabled = true;
        loading.classList.remove("hidden");
        error.classList.add("hidden");
        result.classList.add("hidden");

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        animateLoading();

        try {
          // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆï¼‰
          let authHeaders: Record<string, string> = {
            "Content-Type": "application/json",
          };
          if (supabase && currentUser) {
            const {
              data: { session },
            } = await supabase.auth.getSession();
            if (session?.access_token) {
              authHeaders["Authorization"] = `Bearer ${session.access_token}`;
            }
          }

          const response = await fetch("/api/diagnose", {
            method: "POST",
            headers: authHeaders,
            body: JSON.stringify({ url, language: currentLang }),
          });

          // 401ã‚¨ãƒ©ãƒ¼ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ï¼‰ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          if (response.status === 401) {
            pendingUrl = url;
            showLoginModal();
            throw new Error("LOGIN_REQUIRED");
          }

          const data = await response.json();

          if (!response.ok) {
            // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆ‡ã‚Œã®å ´åˆã¯ç‰¹åˆ¥ãªUIè¡¨ç¤º
            if (data.credits_exhausted) {
              const t = (translations as any)[currentLang];
              const proCard = document.getElementById(
                "pro-upgrade-banner",
              ) as HTMLDivElement;

              // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
              let errorContent = `
              <div class="text-center mb-8">
                <p class="font-bold mb-4 text-xl text-indigo-900">${t.credits_exhausted_msg}</p>
              </div>
            `;

              // Proã‚«ãƒ¼ãƒ‰ã®è¤‡è£½ã¨è¿½åŠ 
              error.innerHTML = errorContent;

              if (proCard) {
                const clone = proCard.cloneNode(true) as HTMLDivElement;
                clone.classList.remove("hidden");
                clone.removeAttribute("id"); // IDé‡è¤‡å›é¿
                clone.classList.add("not-hidden-force"); // å¼·åˆ¶è¡¨ç¤ºç”¨ã®ã‚¯ãƒ©ã‚¹ï¼ˆå¿…è¦ãªã‚‰ï¼‰
                error.appendChild(clone);
              } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ï¼ˆä¸‡ãŒä¸€ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼‰
                error.innerHTML += `
                <div class="text-center">
                  <button id="upgrade-from-error" class="js-pro-upgrade-btn mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    ${t.btn_upgrade_error}
                  </button>
                </div>`;
              }

              error.classList.remove("hidden");
              // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯documentãƒ¬ãƒ™ãƒ«ã®å§”è­²ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚å†è¨­å®šä¸è¦
              return;
            }
            throw new Error(data.error || "è¨ºæ–­ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          displayResult(data);
        } catch (err) {
          // ãƒ­ã‚°ã‚¤ãƒ³èª˜å°æ™‚ã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã—ãªã„
          if (err instanceof Error && err.message === "LOGIN_REQUIRED") {
            return;
          }

          error.textContent =
            err instanceof Error ? err.message : "è¨ºæ–­ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
          error.classList.remove("hidden");
        } finally {
          submitBtn.disabled = false;
          loading.classList.add("hidden");
        }
      });

      function animateLoading() {
        // 3ç§’ã”ã¨ã«ã‚¹ãƒ†ãƒƒãƒ—ã‚’é€²ã‚ã‚‹æ“¬ä¼¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        loadingStep1.className =
          "font-bold text-indigo-600 transition-all duration-500";
        loadingStep2.className = "opacity-50 transition-all duration-500";
        loadingStep3.className = "opacity-50 transition-all duration-500";

        setTimeout(() => {
          loadingStep1.className = "text-green-600 transition-all duration-500"; // å®Œäº†
          loadingStep2.className =
            "font-bold text-indigo-600 transition-all duration-500";
        }, 5000);

        setTimeout(() => {
          loadingStep2.className = "text-green-600 transition-all duration-500"; // å®Œäº†
          loadingStep3.className =
            "font-bold text-indigo-600 transition-all duration-500";
        }, 15000);
      }

      resetBtn.addEventListener("click", () => {
        result.classList.add("hidden");
        urlInput.value = "";
        urlInput.focus();
      });

      function displayResult(data: {
        summary: string;
        geo_score: number;
        is_premium?: boolean;
        free_credits?: number;
        scores?: {
          structure: number;
          context: number;
          freshness: number;
          credibility: number;
        };
        strengths: string[];
        issues: {
          title: string;
          description: string;
          impact: string;
          category?: string;
          suggestion?: string;
        }[];
        impression: string;
      }) {
        // GEOã‚¹ã‚³ã‚¢
        const scoreDisplay = document.getElementById(
          "score-display",
        ) as HTMLDivElement;
        const scoreBar = document.getElementById("score-bar") as HTMLDivElement;
        scoreDisplay.textContent = String(data.geo_score);
        scoreBar.style.width = `${data.geo_score}%`;

        // ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦è‰²ã‚’å¤‰æ›´
        if (data.geo_score >= 70) {
          scoreDisplay.className = "text-5xl font-bold text-green-600";
        } else if (data.geo_score >= 40) {
          scoreDisplay.className = "text-5xl font-bold text-yellow-600";
        } else {
          scoreDisplay.className = "text-5xl font-bold text-red-600";
        }

        // 4è»¸è©³ç´°ã‚¹ã‚³ã‚¢ + ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ¶å¾¡
        const scoresDetail = document.getElementById(
          "scores-detail",
        ) as HTMLDivElement;
        if (data.scores) {
          scoresDetail.classList.remove("hidden");
          const isPremium = data.is_premium || false;

          (
            document.getElementById("score-structure") as HTMLDivElement
          ).textContent = String(data.scores.structure);
          (
            document.getElementById("score-context") as HTMLDivElement
          ).textContent = isPremium ? String(data.scores.context) : "???";
          (
            document.getElementById("score-freshness") as HTMLDivElement
          ).textContent = isPremium ? String(data.scores.freshness) : "???";
          (
            document.getElementById("score-credibility") as HTMLDivElement
          ).textContent = isPremium ? String(data.scores.credibility) : "???";

          // ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºåˆ¶å¾¡ï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
          const maskContext = document.getElementById("mask-context");
          const maskFreshness = document.getElementById("mask-freshness");
          const maskCredibility = document.getElementById("mask-credibility");
          const proUpgradeBanner =
            document.getElementById("pro-upgrade-banner");

          if (isPremium) {
            // Proãƒ¦ãƒ¼ã‚¶ãƒ¼: å…¨ã¦è¡¨ç¤º
            maskContext?.classList.add("hidden");
            maskFreshness?.classList.add("hidden");
            maskCredibility?.classList.add("hidden");
            proUpgradeBanner?.classList.add("hidden");
          } else {
            // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼: Structureä»¥å¤–ã‚’ãƒã‚¹ã‚¯
            maskContext?.classList.remove("hidden");
            maskFreshness?.classList.remove("hidden");
            maskCredibility?.classList.remove("hidden");
            proUpgradeBanner?.classList.remove("hidden");
          }
        } else {
          scoresDetail.classList.add("hidden");
        }

        // ç·è©•
        const summaryEl = document.getElementById(
          "result-summary",
        ) as HTMLParagraphElement;
        summaryEl.textContent = data.summary;

        // è‰¯ã„ç‚¹
        const strengthsEl = document.getElementById(
          "result-strengths",
        ) as HTMLUListElement;
        const t = (translations as any)[currentLang];

        if (data.strengths.length > 0) {
          strengthsEl.innerHTML = data.strengths
            .map(
              (s) =>
                `<li class="flex items-start gap-2"><span class="text-emerald-600">âœ“</span><span>${s}</span></li>`,
            )
            .join("");
        } else {
          strengthsEl.innerHTML = `<li class="text-slate-500 italic">${t.no_strengths_found}</li>`;
        }

        // æ°—ã«ãªã‚‹ç‚¹ï¼ˆå¼•ç”¨æ©Ÿä¼šã¸ã®å½±éŸ¿åº¦ä»˜ãï¼‰
        const issuesEl = document.getElementById(
          "result-issues",
        ) as HTMLDivElement;

        let issuesHtml = "";

        if (data.issues.length > 0) {
          issuesHtml = data.issues
            .map((issue, index) => {
              const t = (translations as any)[currentLang];
              // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯1å€‹ç›®ä»¥å¤–ãƒã‚¹ã‚¯è¡¨ç¤º
              const isLocked = !data.is_premium && index >= 1;

              let impactClass = "bg-blue-100 text-blue-800";
              let impactText = t.impact_low;

              if (["High", "å¤§"].includes(issue.impact)) {
                impactClass = "bg-red-100 text-red-800";
                impactText = t.impact_high;
              } else if (["Medium", "ä¸­"].includes(issue.impact)) {
                impactClass = "bg-yellow-100 text-yellow-800";
                impactText = t.impact_medium;
              }

              const suggestionHtml = issue.suggestion
                ? `<div class="mt-3 p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
                   <p class="text-xs font-medium text-emerald-800 mb-1">${t.suggestion_prefix}</p>
                   <p class="text-sm text-emerald-700">${issue.suggestion}</p>
                 </div>`
                : "";

              // ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒã‚¹ã‚¯è¡¨ç¤º
              if (isLocked) {
                return `
                <div class="bg-white rounded-lg p-4 relative overflow-hidden border border-slate-100">
                  <div class="filter blur-md select-none pointer-events-none opacity-50">
                    <div class="flex items-center gap-2 mb-2">
                      <h4 class="font-bold text-slate-800">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</h4>
                      <span class="text-xs px-2 py-0.5 rounded ${impactClass}">${impactText}</span>
                    </div>
                    <p class="text-slate-600 text-sm">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</p>
                  </div>
                  <div class="absolute inset-0 flex flex-col items-center justify-center z-10 cursor-pointer hover:bg-white/10 transition" onclick="document.getElementById('pro-upgrade-banner').scrollIntoView({behavior: 'smooth'})">
                       <div class="bg-indigo-600 text-white px-5 py-3 rounded-xl font-bold flex items-center gap-2 shadow-2xl transform hover:scale-105 transition border border-indigo-500">
                          <span>${t.pro_lock}</span>
                       </div>
                  </div>
                </div>
              `;
              }

              return `
              <div class="bg-white rounded-lg p-4 relative overflow-hidden group border border-slate-100 hover:shadow-md transition">
                <div class="transition duration-500">
                  <div class="flex items-center gap-2 mb-2">
                    <h4 class="font-bold text-slate-800">${issue.title}</h4>
                    <span class="text-xs px-2 py-0.5 rounded ${impactClass}">${impactText}</span>
                  </div>
                  <p class="text-slate-600 text-sm">${issue.description}</p>
                  ${suggestionHtml}
                </div>
              </div>
            `;
            })
            .join("");
        } else {
          issuesHtml = `<div class="text-slate-500 italic p-4">${t.no_issues_found}</div>`;
        }

        // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ãƒ€ãƒŸãƒ¼ã®ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸæ”¹å–„æ¡ˆã‚’è¡¨ç¤ºã—ã¦ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’è¨´æ±‚
        if (!data.is_premium) {
          const t = (translations as any)[currentLang];
          // ãƒ€ãƒŸãƒ¼è¦ç´ ã‚’2ã¤è¿½åŠ 
          const dummyLockedHtml = `
          <div class="bg-white rounded-lg p-4 relative overflow-hidden border border-slate-100">
            <div class="filter blur-md select-none pointer-events-none opacity-50">
              <div class="flex items-center gap-2 mb-2">
                <h4 class="font-bold text-slate-800">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</h4>
                <span class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-800">${t.impact_high}</span>
              </div>
              <p class="text-slate-600 text-sm">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</p>
            </div>
            <div class="absolute inset-0 flex flex-col items-center justify-center z-10 cursor-pointer hover:bg-white/10 transition" onclick="document.getElementById('pro-upgrade-banner').scrollIntoView({behavior: 'smooth'})">
                 <div class="bg-indigo-600 text-white px-5 py-3 rounded-xl font-bold flex items-center gap-2 shadow-2xl transform hover:scale-105 transition border border-indigo-500">
                    <span>${t.pro_lock}</span>
                 </div>
            </div>
          </div>
          <div class="bg-white rounded-lg p-4 relative overflow-hidden border border-slate-100">
            <div class="filter blur-md select-none pointer-events-none opacity-50">
               <div class="flex items-center gap-2 mb-2">
                <h4 class="font-bold text-slate-800">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</h4>
                <span class="text-xs px-2 py-0.5 rounded bg-yellow-100 text-yellow-800">${t.impact_medium}</span>
              </div>
              <p class="text-slate-600 text-sm">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</p>
            </div>
            <div class="absolute inset-0 flex flex-col items-center justify-center z-10 cursor-pointer hover:bg-white/10 transition" onclick="document.getElementById('pro-upgrade-banner').scrollIntoView({behavior: 'smooth'})">
                 <div class="bg-indigo-600 text-white px-5 py-3 rounded-xl font-bold flex items-center gap-2 shadow-2xl transform hover:scale-105 transition border border-indigo-500">
                    <span>${t.pro_lock}</span>
                 </div>
            </div>
          </div>
        `;
          issuesHtml += dummyLockedHtml;
        }

        issuesEl.innerHTML = issuesHtml;

        // AIæ¤œç´¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        const impressionEl = document.getElementById(
          "result-impression",
        ) as HTMLDivElement;
        // ç°¡æ˜“Markdownãƒ‘ãƒ¼ã‚µãƒ¼: **bold** ã‚’ <strong>bold</strong> ã«å¤‰æ›
        const formattedImpression = data.impression
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>") // Bold
          .replace(/\n/g, "<br />"); // Newlines
        impressionEl.innerHTML = formattedImpression;

        // æ®‹ã‚Šã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ•°ã®æ›´æ–°ï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰
        const remainingCredits = document.getElementById(
          "remaining-credits",
        ) as HTMLDivElement;
        const remainingCreditsCount = document.getElementById(
          "remaining-credits-count",
        ) as HTMLSpanElement;
        if (!data.is_premium && data.free_credits !== undefined) {
          remainingCredits.classList.remove("hidden");
          remainingCreditsCount.textContent = String(data.free_credits);
          // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨ç¤ºã‚‚æ›´æ–°
          creditsInfo.classList.remove("hidden");
          creditsCount.textContent = String(data.free_credits);
        } else {
          remainingCredits.classList.add("hidden");
          creditsInfo.classList.add("hidden");
        }

        result.classList.remove("hidden");
        result.scrollIntoView({ behavior: "smooth" });
      }
    </script>
  </main>
</Layout>
