---
import Layout from "../layouts/Layout.astro";
---

<Layout title="GEO診断 - AI検索エンジン最適化チェッカー">
  <main class="container mx-auto px-4 py-12 max-w-4xl">
    <!-- ヘッダー -->
    <header class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold text-slate-900 mb-4">
        GEO診断
      </h1>
      <p class="text-xl text-slate-600 max-w-2xl mx-auto">
        AI検索エンジン（ChatGPT、Perplexity、Google AI Overview）に<br
          class="hidden sm:inline"
        />
        <span class="text-indigo-600 font-semibold"
          >「引用されるコンテンツ」</span
        >かどうかを診断します
      </p>
    </header>

    <!-- URL入力フォーム -->
    <section class="bg-white rounded-2xl shadow-xl p-8 mb-8">
      <form id="diagnosis-form" class="space-y-6">
        <div>
          <label
            for="url-input"
            class="block text-sm font-medium text-slate-700 mb-2"
          >
            診断したいURLを入力
          </label>
          <input
            type="url"
            id="url-input"
            name="url"
            placeholder="https://example.com"
            required
            class="w-full px-4 py-3 text-lg border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
          />
        </div>
        <button
          type="submit"
          id="submit-btn"
          class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl text-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          GEO診断を開始する
        </button>
      </form>

      <!-- ローディング -->
      <div id="loading" class="hidden mt-6 text-center">
        <div
          class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-indigo-600 border-t-transparent"
        >
        </div>
        <p class="mt-3 text-slate-600 font-medium">
          AI検索対策を精密診断中...（1〜2分程度）
        </p>
        <div class="mt-4 text-xs text-slate-400 space-y-1">
          <p id="loading-step-1">
            🖥️ ヘッドレスブラウザでコンテンツを取得中...
          </p>
          <p id="loading-step-2" class="opacity-50">
            📸 スクリーンショットを撮影して視覚分析中...
          </p>
          <p id="loading-step-3" class="opacity-50">
            🤖 AIエンジンのアルゴリズムで評価中...
          </p>
        </div>
      </div>

      <!-- エラー表示 -->
      <div
        id="error"
        class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700"
      >
      </div>
    </section>

    <!-- 診断結果 -->
    <section id="result" class="hidden space-y-6">
      <!-- GEOスコア -->
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <h2 class="text-2xl font-bold text-slate-900 mb-4">GEOスコア</h2>
        <div class="flex items-center gap-4">
          <div id="score-display" class="text-5xl font-bold text-indigo-600">
            --
          </div>
          <div class="flex-1">
            <div class="h-4 bg-slate-200 rounded-full overflow-hidden">
              <div
                id="score-bar"
                class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 transition-all duration-500"
                style="width: 0%"
              >
              </div>
            </div>
            <p class="text-sm text-slate-500 mt-1">
              AI検索エンジンに引用される可能性
            </p>
          </div>
        </div>
        <!-- 注意書き -->
        <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
          <p class="text-sm text-amber-800 flex items-start gap-2">
            <span class="flex-shrink-0">⚠️</span>
            <span>
              <strong
                >このスコアはコンテンツ構造の最適度を測定しています。</strong
              ><br />
              ドメインの権威性・被リンク・ブランド認知度は考慮されていません。大手サイト（Reddit、Wikipedia等）は構造が最適化されていなくてもAIに引用されることがあります。
            </span>
          </p>
        </div>
      </div>

      <!-- 5指標詳細スコア -->
      <div id="scores-detail" class="bg-white rounded-2xl shadow-xl p-8 hidden">
        <h2 class="text-2xl font-bold text-slate-900 mb-4">5つの評価指標</h2>
        <div class="grid md:grid-cols-5 gap-4">
          <div class="text-center p-4 bg-blue-50 rounded-xl">
            <div id="score-info-gain" class="text-3xl font-bold text-blue-600">
              --
            </div>
            <p class="text-xs text-slate-600 mt-1">情報獲得量</p>
          </div>
          <div class="text-center p-4 bg-purple-50 rounded-xl">
            <div id="score-entity" class="text-3xl font-bold text-purple-600">
              --
            </div>
            <p class="text-xs text-slate-600 mt-1">エンティティ明確性</p>
          </div>
          <div class="text-center p-4 bg-green-50 rounded-xl">
            <div id="score-format" class="text-3xl font-bold text-green-600">
              --
            </div>
            <p class="text-xs text-slate-600 mt-1">引用形式適合</p>
          </div>
          <div class="text-center p-4 bg-orange-50 rounded-xl">
            <div
              id="score-directness"
              class="text-3xl font-bold text-orange-600"
            >
              --
            </div>
            <p class="text-xs text-slate-600 mt-1">回答直接性</p>
          </div>
          <div class="text-center p-4 bg-red-50 rounded-xl">
            <div
              id="score-hallucination"
              class="text-3xl font-bold text-red-600"
            >
              --
            </div>
            <p class="text-xs text-slate-600 mt-1">信頼性</p>
          </div>
        </div>
      </div>

      <!-- 総評 -->
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <h2 class="text-2xl font-bold text-slate-900 mb-4">総評</h2>
        <p id="result-summary" class="text-lg text-slate-700 leading-relaxed">
        </p>
      </div>

      <!-- 良い点 -->
      <div class="bg-emerald-50 rounded-2xl shadow-xl p-8">
        <h2 class="text-2xl font-bold text-emerald-800 mb-4">
          AIに評価されるポイント
        </h2>
        <ul id="result-strengths" class="space-y-2"></ul>
      </div>

      <!-- 気になる点 -->
      <div class="bg-amber-50 rounded-2xl shadow-xl p-8">
        <h2 class="text-2xl font-bold text-amber-800 mb-4">
          引用機会を損なうポイント
        </h2>
        <div id="result-issues" class="space-y-4"></div>
      </div>

      <!-- AI検索プレビュー（ChatGPT風UI） -->
      <div class="bg-slate-900 rounded-2xl shadow-xl p-8">
        <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.896zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08-4.778 2.758a.795.795 0 0 0-.393.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.597 1.5-2.607-1.5z"
            ></path>
          </svg>
          AI検索での表示プレビュー
        </h2>
        <div class="flex gap-3">
          <div
            class="w-8 h-8 rounded-full bg-teal-500 flex items-center justify-center flex-shrink-0"
          >
            <svg
              class="w-5 h-5 text-white"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494z"
              ></path>
            </svg>
          </div>
          <div
            id="result-impression"
            class="bg-slate-800 rounded-2xl rounded-tl-none p-4 text-slate-100 leading-relaxed flex-1"
          >
          </div>
        </div>
      </div>

      <!-- 再診断ボタン -->
      <div class="text-center">
        <button
          id="reset-btn"
          class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium py-3 px-8 rounded-xl transition"
        >
          別のURLを診断する
        </button>
      </div>
    </section>

    <!-- 特徴説明 -->
    <section class="mt-16 grid md:grid-cols-3 gap-6">
      <div class="bg-white rounded-xl p-6 shadow-lg">
        <div class="text-3xl mb-3">👁️</div>
        <h3 class="font-bold text-lg mb-2">視覚的信頼性を分析</h3>
        <p class="text-slate-600 text-sm">
          Vision（画像認識）機能で、デザインや図解のわかりやすさも評価。
        </p>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg">
        <div class="text-3xl mb-3">🖥️</div>
        <h3 class="font-bold text-lg mb-2">動的サイト完全対応</h3>
        <p class="text-slate-600 text-sm">
          JSで描画されるSPAサイトも、実際の表示通りに正確に診断。
        </p>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg">
        <div class="text-3xl mb-3">💡</div>
        <h3 class="font-bold text-lg mb-2">具体的な改善指示</h3>
        <p class="text-slate-600 text-sm">
          エンジニア・ライター向けに即座に修正できる技術的指摘を提供。
        </p>
      </div>
    </section>

    <!-- フッター -->
    <footer class="mt-16 text-center text-slate-500 text-sm">
      <p>&copy; 2025 GEO診断 (Vision Enhanced)</p>
    </footer>
  </main>

  <script>
    const form = document.getElementById("diagnosis-form") as HTMLFormElement;
    const urlInput = document.getElementById("url-input") as HTMLInputElement;
    const submitBtn = document.getElementById(
      "submit-btn",
    ) as HTMLButtonElement;
    const loading = document.getElementById("loading") as HTMLDivElement;
    const error = document.getElementById("error") as HTMLDivElement;
    const result = document.getElementById("result") as HTMLElement;
    const resetBtn = document.getElementById("reset-btn") as HTMLButtonElement;

    // ローディングステップ要素
    const loadingStep1 = document.getElementById(
      "loading-step-1",
    ) as HTMLParagraphElement;
    const loadingStep2 = document.getElementById(
      "loading-step-2",
    ) as HTMLParagraphElement;
    const loadingStep3 = document.getElementById(
      "loading-step-3",
    ) as HTMLParagraphElement;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const url = urlInput.value.trim();
      if (!url) return;

      // UI更新
      submitBtn.disabled = true;
      loading.classList.remove("hidden");
      error.classList.add("hidden");
      result.classList.add("hidden");

      // ローディングアニメーション開始
      animateLoading();

      try {
        const response = await fetch("/api/diagnose", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url }),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || "診断に失敗しました");
        }

        const data = await response.json();
        displayResult(data);
      } catch (err) {
        error.textContent =
          err instanceof Error ? err.message : "診断中にエラーが発生しました";
        error.classList.remove("hidden");
      } finally {
        submitBtn.disabled = false;
        loading.classList.add("hidden");
      }
    });

    function animateLoading() {
      // 3秒ごとにステップを進める擬似アニメーション
      loadingStep1.className =
        "font-bold text-indigo-600 transition-all duration-500";
      loadingStep2.className = "opacity-50 transition-all duration-500";
      loadingStep3.className = "opacity-50 transition-all duration-500";

      setTimeout(() => {
        loadingStep1.className = "text-green-600 transition-all duration-500"; // 完了
        loadingStep2.className =
          "font-bold text-indigo-600 transition-all duration-500";
      }, 5000);

      setTimeout(() => {
        loadingStep2.className = "text-green-600 transition-all duration-500"; // 完了
        loadingStep3.className =
          "font-bold text-indigo-600 transition-all duration-500";
      }, 15000);
    }

    resetBtn.addEventListener("click", () => {
      result.classList.add("hidden");
      urlInput.value = "";
      urlInput.focus();
    });

    function displayResult(data: {
      summary: string;
      geo_score: number;
      scores?: {
        information_gain: number;
        entity_clarity: number;
        format_suitability: number;
        answer_directness: number;
        hallucination_risk: number;
      };
      strengths: string[];
      issues: {
        title: string;
        description: string;
        impact: string;
        suggestion?: string;
      }[];
      impression: string;
    }) {
      // GEOスコア
      const scoreDisplay = document.getElementById(
        "score-display",
      ) as HTMLDivElement;
      const scoreBar = document.getElementById("score-bar") as HTMLDivElement;
      scoreDisplay.textContent = String(data.geo_score);
      scoreBar.style.width = `${data.geo_score}%`;

      // スコアに応じて色を変更
      if (data.geo_score >= 70) {
        scoreDisplay.className = "text-5xl font-bold text-green-600";
      } else if (data.geo_score >= 40) {
        scoreDisplay.className = "text-5xl font-bold text-yellow-600";
      } else {
        scoreDisplay.className = "text-5xl font-bold text-red-600";
      }

      // 5指標詳細スコア
      const scoresDetail = document.getElementById(
        "scores-detail",
      ) as HTMLDivElement;
      if (data.scores) {
        scoresDetail.classList.remove("hidden");
        (
          document.getElementById("score-info-gain") as HTMLDivElement
        ).textContent = String(data.scores.information_gain);
        (
          document.getElementById("score-entity") as HTMLDivElement
        ).textContent = String(data.scores.entity_clarity);
        (
          document.getElementById("score-format") as HTMLDivElement
        ).textContent = String(data.scores.format_suitability);
        (
          document.getElementById("score-directness") as HTMLDivElement
        ).textContent = String(data.scores.answer_directness);
        (
          document.getElementById("score-hallucination") as HTMLDivElement
        ).textContent = String(data.scores.hallucination_risk);
      } else {
        scoresDetail.classList.add("hidden");
      }

      // 総評
      const summaryEl = document.getElementById(
        "result-summary",
      ) as HTMLParagraphElement;
      summaryEl.textContent = data.summary;

      // 良い点
      const strengthsEl = document.getElementById(
        "result-strengths",
      ) as HTMLUListElement;
      strengthsEl.innerHTML = data.strengths
        .map(
          (s) =>
            `<li class="flex items-start gap-2"><span class="text-emerald-600">✓</span><span>${s}</span></li>`,
        )
        .join("");

      // 気になる点（引用機会への影響度付き）
      const issuesEl = document.getElementById(
        "result-issues",
      ) as HTMLDivElement;
      issuesEl.innerHTML = data.issues
        .map((issue) => {
          const impactColor =
            issue.impact === "大"
              ? "bg-red-100 text-red-800"
              : issue.impact === "中"
                ? "bg-yellow-100 text-yellow-800"
                : "bg-blue-100 text-blue-800";
          const suggestionHtml = issue.suggestion
            ? `<div class="mt-3 p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
                <p class="text-xs font-medium text-emerald-800 mb-1">💡 改善提案:</p>
                <p class="text-sm text-emerald-700">${issue.suggestion}</p>
              </div>`
            : "";
          return `
            <div class="bg-white rounded-lg p-4">
              <div class="flex items-center gap-2 mb-2">
                <h4 class="font-bold text-amber-900">${issue.title}</h4>
                <span class="text-xs px-2 py-0.5 rounded ${impactColor}">影響: ${issue.impact}</span>
              </div>
              <p class="text-slate-700 text-sm">${issue.description}</p>
              ${suggestionHtml}
            </div>
          `;
        })
        .join("");

      // AI検索プレビュー
      const impressionEl = document.getElementById(
        "result-impression",
      ) as HTMLDivElement;
      impressionEl.textContent = data.impression;

      result.classList.remove("hidden");
      result.scrollIntoView({ behavior: "smooth" });
    }
  </script>
</Layout>
